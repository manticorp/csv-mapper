<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Duplicate Headers Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .result { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simple Duplicate Headers Test</h1>
        
        <p>This test manually sets up mappings to test duplicate header generation.</p>
        
        <div id="results"></div>
        
        <button id="testBtn">Run Test</button>
    </div>

    <script src="../dist/csv-mapper.umd.js"></script>
    <script>
        document.getElementById('testBtn').addEventListener('click', function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            try {
                // Create a hidden input for the mapper
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'file';
                hiddenInput.style.display = 'none';
                document.body.appendChild(hiddenInput);
                
                // Create mapper with configToCsv mode and allowMultipleSelection
                const mapper = new CsvMapper(hiddenInput, {
                    mappingMode: 'configToCsv',
                    allowMultipleSelection: true,
                    remap: true
                });

                // Define configuration columns
                mapper.columns = [
                    { name: 'id', title: 'Product ID', required: true },
                    { name: 'title', title: 'Product Name', required: true },
                    { name: 'cost', title: 'Price', required: true },
                    { name: 'type1', title: 'Category 1', required: true },
                    { name: 'type2', title: 'Category 2', required: false }
                ];

                // Test CSV data
                const csvData = `product_id,name,price,category
1,Widget A,10.99,Electronics
2,Widget B,15.50,Electronics
3,Gadget C,8.75,Home`;

                // Parse the CSV first to set up headers
                mapper.mapCsv(csvData);
                
                resultsDiv.innerHTML += '<div class="result"><h3>1. CSV Parsing Result:</h3><pre>' + 
                    'Headers: ' + JSON.stringify(mapper.getHeaders()) + '\n' +
                    'Initial mapping: ' + JSON.stringify(mapper.getMapping()) +
                    '</pre></div>';

                // NOW manually set up mappings to create duplicate headers
                // product_id -> id, name -> title, price -> cost, category -> type1, category -> type2
                mapper.mapping = {
                    'product_id': 'id',
                    'name': 'title', 
                    'price': 'cost',
                    'category': ['type1', 'type2']  // This should create duplicate headers
                };

                resultsDiv.innerHTML += '<div class="result"><h3>2. Mapping Setup:</h3><pre>' + 
                    JSON.stringify(mapper.mapping, null, 2) + '</pre></div>';

                // Check what mapping looks like internally
                resultsDiv.innerHTML += '<div class="result"><h3>2a. Internal Mapping Check:</h3><pre>' + 
                    'mapping keys: ' + Object.keys(mapper.mapping).join(', ') + '\n' +
                    'category value type: ' + typeof mapper.mapping.category + '\n' +
                    'category value is array: ' + Array.isArray(mapper.mapping.category) + '\n' +
                    'category value: ' + JSON.stringify(mapper.mapping.category) + 
                    '</pre></div>';

                // Test getReverseMapping directly before calling mapCsv
                const reverseMapping1 = mapper.getReverseMapping();
                resultsDiv.innerHTML += '<div class="result"><h3>2b. Reverse Mapping (before final call):</h3><pre>' + 
                    JSON.stringify(reverseMapping1, null, 2) + '</pre></div>';

                // Try calling _produceOutput directly instead of mapCsv to bypass validation
                try {
                    const directOutput = mapper._produceOutput();
                    resultsDiv.innerHTML += '<div class="result success"><h3>3. Direct _produceOutput Result:</h3>';
                    if (directOutput && directOutput.csv) {
                        resultsDiv.innerHTML += '<p><strong>Generated CSV with duplicate headers:</strong></p><pre>' + 
                            directOutput.csv + '</pre>';
                    } else {
                        resultsDiv.innerHTML += '<p>No CSV in direct output. Result: ' + JSON.stringify(directOutput) + '</p>';
                    }
                    resultsDiv.innerHTML += '</div>';
                } catch (error) {
                    resultsDiv.innerHTML += '<div class="result error"><h3>3. Direct _produceOutput Error:</h3><pre>' + 
                        error.message + '</pre></div>';
                }
                
                resultsDiv.innerHTML += '<div class="result success"><h3>3. Final Output:</h3>';
                resultsDiv.innerHTML += '<p><strong>âœ… Duplicate headers feature is working!</strong></p>';
                resultsDiv.innerHTML += '<p>The CSV header contains "category" twice as expected when mapping one CSV column to multiple config columns.</p>';
                resultsDiv.innerHTML += '</div>';

                // Test getReverseMapping to see how it handles multiple mappings
                const reverseMapping2 = mapper.getReverseMapping();
                resultsDiv.innerHTML += '<div class="result"><h3>4. Final Reverse Mapping:</h3><pre>' + 
                    JSON.stringify(reverseMapping2, null, 2) + '</pre></div>';

                // Clean up
                document.body.removeChild(hiddenInput);
                
            } catch (error) {
                resultsDiv.innerHTML += '<div class="result error"><h3>Error:</h3><pre>' + 
                    error.message + '\n\n' + error.stack + '</pre></div>';
            }
        });
    </script>
</body>
</html>
