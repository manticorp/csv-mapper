<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CSV Mapper â€¢ Required Columns Example</title>
  </head>
  <body>
    <h1>CSV Mapper - Required Columns Demo</h1>
    <p>This demo shows how to use required columns. Try uploading a CSV and see how required columns are marked with * and validation works.</p>
    
    <form method="POST" id="form">
      <input id="csv" type="file" accept=".csv">
      <input id="map" type="hidden">
      <div id="remapping-controls"></div>
      <button type="submit">Submit (will validate required columns)</button>
    </form>

    <div id="output"></div>

    <script type="module">
      import CsvMapper from "./../dist/csv-mapper.esm.js";
      
      const options = {
        headers: true,
        remap: true,
        showUserControls: true,
        columns: [
          { name: 'id', title: 'Product ID', required: true },
          { name: 'name', title: 'Product Name', required: true },
          { name: 'sku', title: 'SKU Code', required: false },
          { name: 'qty', title: 'Quantity', required: false },
          { name: 'price', title: 'Price', required: true }
        ]
      };
      
      const fileMap = new CsvMapper('#csv', options);

      // Listen for validation changes
      fileMap.addEventListener('validationChange', (event) => {
        const { isValid, missingRequired } = event.detail;
        const submitBtn = document.querySelector('button[type="submit"]');
        
        if (isValid) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit (Ready!)';
          submitBtn.style.backgroundColor = '';
        } else {
          submitBtn.disabled = true;
          submitBtn.textContent = `Cannot Submit - Missing: ${missingRequired.join(', ')}`;
          submitBtn.style.backgroundColor = '#ff6b6b';
        }
      });

      document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          // Check if mapping is valid
          const validation = fileMap.validateMapping();
          
          if (!validation.isValid) {
            alert(`Cannot submit: Required columns are missing: ${validation.missingRequired.join(', ')}`);
            return;
          }
          
          // Get the mapped data
          const { mappedRows, csv } = fileMap._produceOutput();
          
          document.getElementById('output').innerHTML = `
            <h2>Success!</h2>
            <p>Mapped ${mappedRows.length} rows successfully.</p>
            <pre>${JSON.stringify(mappedRows.slice(0, 5), null, 2)}</pre>
            ${mappedRows.length > 5 ? '<p>... (showing first 5 rows)</p>' : ''}
          `;
          
        } catch (error) {
          document.getElementById('output').innerHTML = `
            <h2>Error:</h2>
            <p style="color: red;">${error.message}</p>
          `;
        }
      });
    </script>
  </body>
</html>
