<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Mapper - Transformation</title>
    <link href="css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.css" integrity="sha256-jsQbSO1yj62eu6dP6f2fJESRgkHNNEpxrK8NnO6/oyc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/match-braces/prism-match-braces.min.css" integrity="sha256-ofzmpw1bhHX6o2yPsxm/qv2HF/pxkmWJhQiMnlQ+4Tw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism-okaidia.min.css" integrity="sha256-zzHVEO0xOoVm0I6bT9v5SgpRs1cYNyvEvHXW/1yCgqU=" crossorigin="anonymous">
  </head>
  <body>
    <section class="section">
        <div class="container content">
            <h1 class="title">Transformation ‚úÖ‚ùå</h1>
            <p>This is a demonstration of some of the transformation features of CsvMapper.</p>

            <div class="block">
                <h2>CsvMapper Setup Code</h2>
                <details>
                    <summary>Code Sample</summary>
                    <div id="code-sample">
                    </div>
                </details>
                <details>
                    <summary>CSV Sample</summary>
                    <pre><code class="language-csv" id="sample-csv">id,name,email_address,phone_number,date,iso8601_date,number,number_with_min_max,boolean
AB1 ,D√°ri√∫s √ângl√©bert,darius@example.com,555-1234,2023-01-01,2023-01-01,1,4,1
AB2 ,Jane Smith,jane@example.com,555-5678,2023-01-02,2023-01-02,2,3,0
 AB3,Bob Wilson,bob@example.com,555-9999,2023-01-03,2023-01-03,3.141,1,"Yes"</code></pre>
                </details>
            </div>

            <div class="block">
                <h2>Test Setup</h2>
                <input type="file" id="csv-file" accept=".csv">
            </div>

            <div class="block">
                <h2>Events Log</h2>
                <div id="events-log"></div>
            </div>

            <div class="block">
                <h2>Result</h2>
                <div id="result"></div>
            </div>
        </div>
    </section>
    <script src="../dist/csv-mapper.umd.min.js"></script>
    <script id="base-script">
        // Setup CSV Mapper with required columns
        const columns = [
            {
                name: 'id',
                title: 'ID',
                required: true,
                transform: 'trim',
            },
            {
                name: 'name',
                title: 'Name',
                required: true,
                transform: 'trim',
            },
            {
                name: 'ascii_name',
                title: 'Ascii Name',
                required: false,
                transform: 'ascii',
            },
            {
                name: 'complex_string_processing',
                title: 'Complex String Processing',
                required: false,
                transform: ['string', 'trim', 'title']
            },
            {
                name: 'email',
                title: 'Email',
                required: false,
                transform: 'trim',
            },
            {
                name: 'phone',
                title: 'Phone',
                required: false,
                transform: 'trim',
            },
            {
                name: 'number',
                title: 'Number',
                required: false,
                transform: {
                    type: 'number',
                }
            },
            {
                name: 'boolean',
                title: 'Boolean',
                required: false,
                validate: 'boolean',
                transform: {
                    type: 'boolean',
                }
            },
            {
                name: 'date',
                title: 'Date',
                required: false,
                validate: 'date',
                transform: {
                    type: 'date',
                    format: 'd-m-Y'
                }
            },
            {
                name: 'iso8601',
                title: 'ISO8601 Date',
                required: false,
                transform: {
                    type: 'date',
                    format: 'iso8601'
                }
            }
        ];

        const csvMapper = new CsvMapper('#csv-file', {
            columns,
            allowMultipleSelection: true,
            controlsContainer: '#controls',
            setInputValidity: true
        });
    </script>
    <script>
        unindent = (s) => {
            let lines = s.split('\n')
            while (lines[0].trim() === '') {
                lines = lines.slice(1);
            }
            while (lines[lines.length-1].trim() === '') {
                lines = lines.slice(0, -1);
            }
            const minLeftIndent = lines.slice(0, lines.length-2).map(line => line == '' ? 99999 : line.match(/^\s*/)[0].length);
            const minIndent = Math.min(...minLeftIndent);
            return lines.map(line => line.slice(minIndent)).join('\n');
        };
        document.getElementById('code-sample').innerHTML = '<pre><code class="language-javascript">' + unindent(document.getElementById('base-script').innerHTML) + '</code></pre>';

        const eventsLog = document.getElementById('events-log');
        const methodTests = document.getElementById('method-tests');

        function logEvent(type, data) {
            const logEntry = document.createElement('div');
            logEntry.className = 'block result log';
            logEntry.innerHTML = `
                <strong>${type}</strong> - ${new Date().toLocaleTimeString()}
                <pre><code class="language-json">${JSON.stringify(data, null, 2)}</code></pre>
            `;
            eventsLog.appendChild(logEntry);
            Prism.highlightElement(logEntry.querySelector('pre code'));
        }

        csvMapper.addEventListener('mappingFailed', (event) => {
            logEvent('mappingFailed', event.detail);
        });

        csvMapper.addEventListener('transformationFail', (event) => {
            logEvent('transformationFail', event.detail);
        });

        csvMapper.addEventListener('validationFail', (event) => {
            logEvent('validationFail', event.detail);
        });

        csvMapper.addEventListener('validationFailed', (event) => {
            logEvent('validationFailed', event.detail);
        });

        csvMapper.addEventListener('afterRead', (event) => {
            logEvent('afterRead', event.detail);
        });

        csvMapper.addEventListener('afterRemap', (event) => {
            logEvent('afterRemap', {
                rowCount: event.detail.rows.length,
                hasCsv: !!event.detail.csv
            });
        });

        // Create sample CSV for testing
        const sampleCsv = document.getElementById('sample-csv').innerHTML.trim();

        setTimeout(() => {
            csvMapper.setCsv(sampleCsv);
            csvMapper.autoMap();
            csvMapper.addColumnMapping('name', 'ascii_name');
            csvMapper.addColumnMapping('name', 'complex_string_processing');
            const result = csvMapper.getMappedResult();
            if (result.csv) {
                document.getElementById('result').innerHTML = `
                    <h3>CSV Result:</h3>
                    <pre class="language-json"><code>${result.csv}</code></pre>
                `;
                Prism.highlightAll();
            }
        }, 10);

        console.log('üß™ Validation test page loaded');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-AjM0J5XIbiB590BrznLEgZGLnOQWrt62s3BEq65Q/I0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.js" integrity="sha256-NSwb7O0HrDJcC+2SASgGuCP8+tdpIhqnzLTZkGRJRCk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/show-language/prism-show-language.min.js" integrity="sha256-Iy5p6AvgpCeFkznsN5PvgtzOzu1zpWLGfVtPF5H9akk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/match-braces/prism-match-braces.min.js" integrity="sha256-+5ZWEZo03rdvJF2quCewrodzNhHu9aDLctMge3kzqYU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js" integrity="sha256-qf3MqHLzDh4qqAnc9QVmqjEWBA4CfzP1YwRFbfNfpnE=" crossorigin="anonymous"></script>
  </body>
</html>
