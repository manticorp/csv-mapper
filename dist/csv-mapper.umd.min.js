!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CsvMapper=e()}(this,function(){"use strict";class t extends EventTarget{constructor(e,s={}){if(super(),this.input="string"==typeof e?document.querySelector(e):e,!(this.input instanceof HTMLInputElement)||"file"!==this.input.type)throw new Error("CsvMapper: first argument must be a file input or selector.");this.opts=Object.assign({separator:"",enclosure:"",escape:"",guessMaxLines:25,outputSeparator:null,outputEnclosure:null,outputEscape:null,headers:!0,remap:!0,showUserControls:!0,mappingInput:null,controlsContainer:null,columns:[],autoThreshold:.8,allowUnmappedTargets:!0,beforeParse:null,beforeMap:null,afterMap:null},s||{}),this.columns=(this.opts.columns||[]).map(t=>"string"==typeof t?{name:t}:Object.assign({},t)),this.columns.forEach(t=>{t.title||(t.title=t.name)}),this.controlsEl=this._resolveNode(this.opts.controlsContainer)||this._autoinsertContainer(),this.mapping={},this.headers=[],this.rows=[],this.dialect={separator:",",enclosure:'"',escape:null},this._onFileChange=this._onFileChange.bind(this),this.input.addEventListener("change",this._onFileChange),t._ensureStyles()}destroy(){this.input.removeEventListener("change",this._onFileChange),this.controlsEl&&"1"===this.controlsEl.dataset.csvMapperAutocreated&&this.controlsEl.remove()}getMapping(){return Object.assign({},this.mapping)}setMapping(t){this.mapping=Object.assign({},t||{}),this.opts.showUserControls&&this._renderControls()}getHeaders(){return[...this.headers]}getRawRows(){return this.rows.map(t=>Object.assign({},t))}getDialect(){return Object.assign({},this.dialect)}async _onFileChange(){const e=this.input.files&&this.input.files[0];if(!e)return;let s=await e.text();const n=new CustomEvent("beforeParse",{detail:{text:s}});this.dispatchEvent(n),"function"==typeof this.opts.beforeParse&&(s=this.opts.beforeParse(s)??s);const o=t.parseCSV(s,{headers:this.opts.headers,separator:this.opts.separator,enclosure:this.opts.enclosure,escape:this.opts.escape,guessMaxLines:this.opts.guessMaxLines});this.headers=o.headers,this.rows=o.rows,this.dialect=o.dialect,this.mapping=Object.fromEntries(this.headers.map(t=>[t,""])),this._autoMap(),this.opts.showUserControls&&this._renderControls();const r=new CustomEvent("beforeMap",{detail:{rows:this.getRawRows()}});if(this.dispatchEvent(r),"function"==typeof this.opts.beforeMap){const t=this.opts.beforeMap(this.rows);Array.isArray(t)&&(this.rows=t)}const{mappedRows:a,csv:i}=this._produceOutput(),c=new CustomEvent("afterMap",{detail:{rows:a,csv:i}});this.dispatchEvent(c),"function"==typeof this.opts.afterMap&&this.opts.afterMap(a,i);const l=this._resolveNode(this.opts.mappingInput);l instanceof HTMLInputElement&&(l.value=JSON.stringify(this.mapping))}_produceOutput(){const e={};for(const[t,s]of Object.entries(this.mapping)){if(!s)continue;const n=this.columns.find(t=>t.name===s);n&&(e[s]&&!0!==n.allowDuplicates||(e[s]||=[]).push(t))}const s=this.rows.map(s=>{const n={};for(const o of this.columns){const r=e[o.name]||[];let a="";for(const t of r){const e=s[t];if(null!=e&&""!==String(e)){a=e;break}}let i=a;if(o.transform)try{i=o.transform(i,s)}catch(t){console.warn("CsvMapper transform error for",o.name,t)}if(o.validate){if(!t._validate(i,o.validate)){const t=o.validationMessage||`Validation failed for ${o.title||o.name}`;(n.__errors__||=[]).push({field:o.name,message:t,value:i})}}n[o.name]=i??""}return n});let n=null;if(this.opts.remap){const e=this.opts.outputSeparator??this.dialect.separator??",",o=this.opts.outputEnclosure??this.dialect.enclosure??'"',r=this.opts.outputEscape??this.dialect.escape??null,a=this.columns.map(t=>t.title||t.name),i=[t.toCsvRow(a,e,o,r)];for(const n of s){const s=this.columns.map(t=>n[t.name]);i.push(t.toCsvRow(s,e,o,r))}n=i.join("\n")}return{mappedRows:s,csv:n}}_renderControls(){const e=this.controlsEl;if(!e)return;if(!this.headers.length)return void(e.innerHTML=this._banner("No CSV loaded. Choose a file to begin."));const s=e=>{const s=new Map;return Object.values(this.mapping).forEach(t=>{t&&s.set(t,(s.get(t)||0)+1)}),['<option value="">— Ignore —</option>'].concat(this.columns.map(n=>{const o=s.get(n.name)||0,r=!(!0===n.allowDuplicates)&&n.name!==e&&o>0?"disabled":"",a=e===n.name?"selected":"",i=t.escape(n.title||n.name);return`<option value="${t.escape(n.name)}" ${a} ${r}>${i}${n.allowDuplicates?" (multi)":""}</option>`})).join("")},n=this.headers.map(e=>{const n=this.mapping[e]||"";return`<tr>\n        <td><strong>${t.escape(e)}</strong></td>\n        <td><select data-src="${t.escape(e)}">${s(n)}</select></td>\n      </tr>`}).join("");e.innerHTML=`\n      <div class="csvm-card">\n        <div class="csvm-card-h">Map your columns <span class="csvm-tag">${this.rows.length} rows • sep: ${t.escape(this.dialect.separator||",")}</span></div>\n        <div class="csvm-card-b">\n          <table class="csvm-table">\n            <thead><tr><th>Your CSV header</th><th>Map to</th></tr></thead>\n            <tbody>${n}</tbody>\n          </table>\n        </div>\n      </div>`,e.querySelectorAll("select[data-src]").forEach(t=>{t.addEventListener("change",()=>{const e=t.getAttribute("data-src");this.mapping[e]=t.value,this._renderControls();const{mappedRows:s,csv:n}=this._produceOutput(),o=new CustomEvent("afterMap",{detail:{rows:s,csv:n}});this.dispatchEvent(o),"function"==typeof this.opts.afterMap&&this.opts.afterMap(s,n);const r=this._resolveNode(this.opts.mappingInput);r instanceof HTMLInputElement&&(r.value=JSON.stringify(this.mapping))})})}_banner(e){return`<div class="csvm-note">${t.escape(e)}</div>`}_autoMap(){const t=new Map;for(const e of this.headers){let s="",n=0;for(const o of this.columns){const r=t.get(o.name)||0;if(!(!0===o.allowDuplicates||0===r))continue;const a=this._matchScore(e,o);a>n&&(n=a,s=o.name)}n>=this.opts.autoThreshold&&(this.mapping[e]=s,t.set(s,(t.get(s)||0)+1))}}_matchScore(e,s){const n=t.normalize(e),o=t.normalize(s.title||""),r=t.normalize(s.name||"");let a=0;if(s.match instanceof RegExp)(s.match.test(e)||s.match.test(n))&&(a=Math.max(a,1));else if("function"==typeof s.match)try{(s.match(e)||s.match(n))&&(a=Math.max(a,1))}catch(t){}return n!==r&&n!==o||(a=Math.max(a,.98)),(n.includes(r)||n.includes(o))&&(a=Math.max(a,.9)),a=Math.max(a,.85*t.similarity(n,r)),a=Math.max(a,.85*t.similarity(n,o)),a}_resolveNode(t){return t?"string"==typeof t?document.querySelector(t):t:null}_autoinsertContainer(){if(!this.opts.showUserControls)return null;const t=document.createElement("div");return t.dataset.csvMapperAutocreated="1",this.input.insertAdjacentElement("afterend",t),t}static parseCSV(e,{headers:s=!0,separator:n="",enclosure:o="",escape:r="",guessMaxLines:a=25}={}){const i=!n,c=!o,l=""===r||null==r,p=t.detectDialect(e,{separator:i?null:n,enclosure:c?null:o,escape:l?null:r,guessMaxLines:a}),u=p.separator||",",h=p.enclosure||'"',d=p.escape||null,m=t._parseWithDialect(e,u,h,d);if(s){const t=m.shift()||[],e=m.map(e=>Object.fromEntries(t.map((t,s)=>[t,e[s]??""])));return{headers:t,rows:e,dialect:p}}const f=m.reduce((t,e)=>Math.max(t,e.length),0),g=Array.from({length:f},(t,e)=>`Column ${e+1}`),v=m.map(t=>Object.fromEntries(g.map((e,s)=>[e,t[s]??""])));return{headers:g,rows:v,dialect:p}}static _parseWithDialect(t,e,s,n){const o=[];let r=0,a="",i=[],c=!1;for(;r<t.length;){const l=t[r];if(c){if(n&&l===n){if(t[r+1]===s){a+=s,r+=2;continue}a+=l,r++;continue}if(l===s){c=!1,r++;continue}a+=l,r++}else l!==s?l!==e?"\n"!==l?"\r"!==l?n||l!==s||t[r+1]!==s?(a+=l,r++):(a+=s,r+=2):("\n"===t[r+1]&&r++,i.push(a),o.push(i),i=[],a="",r++):(i.push(a),o.push(i),i=[],a="",r++):(i.push(a),a="",r++):(c=!0,r++)}return i.push(a),o.push(i),o.length&&1===o[o.length-1].length&&""===o[o.length-1][0]&&o.pop(),o}static detectDialect(e,{separator:s=null,enclosure:n=null,escape:o=null,guessMaxLines:r=25}={}){const a=s?[s]:[",",";","\t","|",":"],i=n?[n]:['"',"'"],c=null!=o?[o]:[null,"\\"],l=e.split(/\r\n|\n|\r/).filter(t=>t.length>0).slice(0,r);if(0===l.length)return{separator:",",enclosure:'"',escape:null};let p={score:-1/0,sep:",",quote:'"',esc:null};for(const e of a){const s="\t"===e?"\t":e;for(const e of i)for(const n of c)try{const o=t._parseWithDialect(l.join("\n"),s,e,n).map(t=>t.length),r=t._mode(o),a=o.filter(t=>t===r).length,i=r<=1?50:0,c=(l[0].match(new RegExp(t._escRe(s),"g"))||[]).length,u=100*a+5*r+c-i;u>p.score&&(p={score:u,sep:s,quote:e,esc:n})}catch(t){}}return{separator:p.sep,enclosure:p.quote,escape:p.esc}}static _mode(t){const e=new Map;let s=null,n=-1;for(const o of t){const t=(e.get(o)||0)+1;e.set(o,t),t>n&&(s=o,n=t)}return s}static _escRe(t){return t.replace(/[.*+?^${}()|[\]\\]/g,t=>`\\${t}`)}static toCsvRow(t,e=",",s='"',n=null){return t.map(t=>{let o=String(t??"");const r=o.includes(e)||o.includes("\n")||o.includes("\r")||o.includes(s);return o=n?o.split(s).join(n+s):o.split(s).join(s+s),r?s+o+s:o}).join(e)}static normalize(t){return String(t||"").toLowerCase().replace(/[_\-]/g," ").replace(/\s+/g," ").trim()}static similarity(e,s){if(e=t.normalize(e),s=t.normalize(s),!e||!s)return 0;if(e===s)return 1;const n=t=>{const e=new Map;for(let s=0;s<t.length-1;s++){const n=t.slice(s,s+2);e.set(n,(e.get(n)||0)+1)}return e},o=n(e),r=n(s);let a=0,i=0;for(const[t,e]of o)r.has(t)&&(a+=Math.min(e,r.get(t))),i+=e;for(const[,t]of r)i+=t;return 2*a/(i||1)}static _validate(t,e){if(e instanceof RegExp)return e.test(String(t));if("function"==typeof e)return!!e(t);if(e&&"object"==typeof e){const s=e.type;if("number"===s){const s=Number(String(t).replace(",","."));return!Number.isNaN(s)&&(!(null!=e.min&&s<e.min)&&!(null!=e.max&&s>e.max))}if("boolean"===s){const e=String(t).trim().toLowerCase();return["1","0","true","false","yes","no","y","n",""].includes(e)}}return!0}static _ensureStyles(){if(document.getElementById("csvm-style"))return;const t=document.createElement("style");t.id="csvm-style",t.textContent="\n      .csvm-card{background:#0d1533; color:#e7ecff; border:1px solid rgba(255,255,255,.12); border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25)}\n      .csvm-card-h{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.12); font-weight:600; display:flex; align-items:center; gap:10px}\n      .csvm-tag{font:12px/1.2 system-ui; background:rgba(124,156,255,.18); border:1px solid rgba(124,156,255,.35); padding:2px 8px; border-radius:999px}\n      .csvm-card-b{padding:10px 12px}\n      .csvm-table{border-collapse:collapse; width:100%; font: 13px/1.4 system-ui}\n      .csvm-table th,.csvm-table td{border-bottom:1px solid rgba(255,255,255,.12); padding:8px 10px; text-align:left}\n      .csvm-table th{color:#a8b4dc}\n      .csvm-note{margin-top:8px; color:#a8b4dc}\n      .csvm-card select{background:#0b1026; color:#e7ecff; border:1px solid rgba(255,255,255,.18); border-radius:8px; padding:6px 8px}\n    ",document.head.appendChild(t)}static escape(t){return String(null==t?"":t).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))}}return t});
//# sourceMappingURL=csv-mapper.umd.min.js.map
