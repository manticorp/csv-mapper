!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).CsvMapper=t()}(this,function(){"use strict";const e=(()=>{try{return/\p{L}[\p{L}\p{M}\p{N}]*|\p{N}+/gu}catch{return/[A-Za-z0-9]+/g}})();function t(t){return String(t).trim().replace(/[_\-.]+/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2").match(e)||[]}const n=e=>e.toLowerCase(),r=e=>e.toUpperCase(),s=e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase();var i={words:t,lower:n,upper:r,cap:s,camelCase:function(e){return t(e).map(n).map((e,t)=>t?s(e):e).join("")},pascalCase:function(e){return t(e).map(s).join("")},titleCase:function(e,{smallWords:n=!0}={}){const r=new Set(["a","an","and","as","at","but","by","en","for","if","in","of","on","or","the","to","vs","via"]),i=t(e);return i.map((e,t)=>n&&t>0&&t<i.length-1&&r.has(e.toLowerCase())?e.toLowerCase():s(e)).join(" ")},snakeCase:function(e){return t(e).map(n).join("_")},screamingSnakeCase:function(e){return t(e).map(r).join("_")},kebabCase:function(e){return t(e).map(n).join("-")},separateWords:function(e){return t(e).join(" ")},ascii:function(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}};class a{constructor(e,t,n=null){this.index=0,this.iterIndex=0,this.genIndex=0,this.index=e,this.headers=n,this.data=t,this.headers&&this._checkHeaderLength()}_checkHeaderLength(){if(this.headers){if(this.headers.length<this.data.length)throw new Error("Not enough headers for data");if(this.headers.length>this.data.length)throw new Error("Too many headers for data")}}get(e){if("number"==typeof e)return this.data[e]??null;if(!this.headers)throw new Error(`Cannot get header "${e}" by name without headers`);const t=[];return this.headers.forEach((n,r)=>{e===n&&t.push(this.data[r])}),0===t.length?null:1===t.length?t[0]:t}set(e,t){if("number"==typeof e)this.data[e]=t;else{if(!this.headers)throw new Error(`Cannot set header "${e}" by name without headers`);this.headers.forEach((n,r)=>{e===n&&(this.data[r]=t)})}return this}[Symbol.iterator](){return this}next(){return this.iterIndex<this.data.length?{value:this.data[this.iterIndex++],done:!1}:{done:!0,value:void 0}}return(e){return this.iterIndex=0,{done:!0,value:e}}throw(e){return this.iterIndex=0,{done:!0,value:void 0}}*entries(){let e=0;for(;e<this.data.length;)this.headers?yield[e,this.data[e],this.headers[e]]:yield[e,this.data[e],null],e++}arrange(e){if(this.headers){const t=this.headers.slice(),n=this.data.slice(),r=[];for(const s of e){const e=t.indexOf(s);if(-1===e)throw new Error(`Header "${s}" not found`);if(void 0===n[e])throw new Error(`Data at at index ${e} for header "${s}" not found`);r.push(n[e]),t.splice(e,1),n.splice(e,1)}return r}throw new Error("Headers not defined - cannot arrange")}toPlainObject(){if(!this.headers)return this.data;const e={};if(this.headers)for(const t in this.headers){const n=this.headers[t];void 0!==e[n]?Array.isArray(e[n])?e[n].push(this.data[t]??null):e[n]=[e[n],this.data[t]??null]:e[n]=this.data[t]??null}return e}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l={exports:{}};
/* @license
    Papa Parse
    v5.5.3
    https://github.com/mholt/PapaParse
    License: MIT
    */!function(e){e.exports=function e(){var t,n="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==n?n:{},r=!n.document&&!!n.postMessage,s=n.IS_PAPA_WORKER||!1,i={},a=0,o={};function l(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(e){var t=w(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null),this._handle=new p(t),(this._handle.streamer=this)._config=t}.call(this,e),this.parseChunk=function(e,t){var r=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<r){let t=this._config.newline;t||(i=this._config.quoteChar||'"',t=this._handle.guessLineEndings(e,i)),e=[...e.split(t).slice(r)].join(t)}this.isFirstChunk&&C(this._config.beforeFirstChunk)&&void 0!==(i=this._config.beforeFirstChunk(e))&&(e=i),this.isFirstChunk=!1,this._halted=!1,r=this._partialLine+e;var i=(this._partialLine="",this._handle.parse(r,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(e=i.meta.cursor,this._finished||(this._partialLine=r.substring(e-this._baseIndex),this._baseIndex=e),i&&i.data&&(this._rowCount+=i.data.length),r=this._finished||this._config.preview&&this._rowCount>=this._config.preview,s)n.postMessage({results:i,workerId:o.WORKER_ID,finished:r});else if(C(this._config.chunk)&&!t){if(this._config.chunk(i,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=i=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(i.data),this._completeResults.errors=this._completeResults.errors.concat(i.errors),this._completeResults.meta=i.meta),this._completed||!r||!C(this._config.complete)||i&&i.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),r||i&&i.meta.paused||this._nextChunk(),i}this._halted=!0},this._sendError=function(e){C(this._config.error)?this._config.error(e):s&&this._config.error&&n.postMessage({workerId:o.WORKER_ID,error:e,finished:!1})}}function h(e){var t;(e=e||{}).chunkSize||(e.chunkSize=o.RemoteChunkSize),l.call(this,e),this._nextChunk=r?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),r||(t.onload=_(this._chunkLoaded,this),t.onerror=_(this._chunkError,this)),t.open(this._config.downloadRequestBody?"POST":"GET",this._input,!r),this._config.downloadRequestHeaders){var e,n=this._config.downloadRequestHeaders;for(e in n)t.setRequestHeader(e,n[e])}var s;this._config.chunkSize&&(s=this._start+this._config.chunkSize-1,t.setRequestHeader("Range","bytes="+this._start+"-"+s));try{t.send(this._config.downloadRequestBody)}catch(e){this._chunkError(e.message)}r&&0===t.status&&this._chunkError()}},this._chunkLoaded=function(){4===t.readyState&&(t.status<200||400<=t.status?this._chunkError():(this._start+=this._config.chunkSize||t.responseText.length,this._finished=!this._config.chunkSize||this._start>=(e=>null!==(e=e.getResponseHeader("Content-Range"))?parseInt(e.substring(e.lastIndexOf("/")+1)):-1)(t),this.parseChunk(t.responseText)))},this._chunkError=function(e){e=t.statusText||e,this._sendError(new Error(e))}}function d(e){(e=e||{}).chunkSize||(e.chunkSize=o.LocalChunkSize),l.call(this,e);var t,n,r="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,n=e.slice||e.webkitSlice||e.mozSlice,r?((t=new FileReader).onload=_(this._chunkLoaded,this),t.onerror=_(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input,s=(this._config.chunkSize&&(s=Math.min(this._start+this._config.chunkSize,this._input.size),e=n.call(e,this._start,s)),t.readAsText(e,this._config.encoding));r||this._chunkLoaded({target:{result:s}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(t.error)}}function u(e){var t;l.call(this,e=e||{}),this.stream=function(e){return t=e,this._nextChunk()},this._nextChunk=function(){var e,n;if(!this._finished)return e=this._config.chunkSize,t=e?(n=t.substring(0,e),t.substring(e)):(n=t,""),this._finished=!t,this.parseChunk(n)}}function c(e){l.call(this,e=e||{});var t=[],n=!0,r=!1;this.pause=function(){l.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){l.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){r&&1===t.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):n=!0},this._streamData=_(function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),n&&(n=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(e){this._streamError(e)}},this),this._streamError=_(function(e){this._streamCleanUp(),this._sendError(e)},this),this._streamEnd=_(function(){this._streamCleanUp(),r=!0,this._streamData("")},this),this._streamCleanUp=_(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function p(e){var t,n,r,s,i=Math.pow(2,53),a=-i,l=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,h=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,d=this,u=0,c=0,p=!1,m=!1,v=[],y={data:[],errors:[],meta:{}};function _(t){return"greedy"===e.skipEmptyLines?""===t.join("").trim():1===t.length&&0===t[0].length}function b(){if(y&&r&&(S("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+o.DefaultDelimiter+"'"),r=!1),e.skipEmptyLines&&(y.data=y.data.filter(function(e){return!_(e)})),M()){if(y)if(Array.isArray(y.data[0])){for(var t=0;M()&&t<y.data.length;t++)y.data[t].forEach(d);y.data.splice(0,1)}else y.data.forEach(d);function d(t,n){C(e.transformHeader)&&(t=e.transformHeader(t,n)),v.push(t)}}function n(t,n){for(var r=e.header?{}:[],s=0;s<t.length;s++){var o=s,d=t[s];d=((t,n)=>(t=>(e.dynamicTypingFunction&&void 0===e.dynamicTyping[t]&&(e.dynamicTyping[t]=e.dynamicTypingFunction(t)),!0===(e.dynamicTyping[t]||e.dynamicTyping)))(t)?"true"===n||"TRUE"===n||"false"!==n&&"FALSE"!==n&&((e=>{if(l.test(e)&&(e=parseFloat(e),a<e&&e<i))return 1})(n)?parseFloat(n):h.test(n)?new Date(n):""===n?null:n):n)(o=e.header?s>=v.length?"__parsed_extra":v[s]:o,d=e.transform?e.transform(d,o):d),"__parsed_extra"===o?(r[o]=r[o]||[],r[o].push(d)):r[o]=d}return e.header&&(s>v.length?S("FieldMismatch","TooManyFields","Too many fields: expected "+v.length+" fields but parsed "+s,c+n):s<v.length&&S("FieldMismatch","TooFewFields","Too few fields: expected "+v.length+" fields but parsed "+s,c+n)),r}var s;y&&(e.header||e.dynamicTyping||e.transform)&&(s=1,!y.data.length||Array.isArray(y.data[0])?(y.data=y.data.map(n),s=y.data.length):y.data=n(y.data,0),e.header&&y.meta&&(y.meta.fields=v),c+=s)}function M(){return e.header&&0===v.length}function S(e,t,n,r){e={type:e,code:t,message:n},void 0!==r&&(e.row=r),y.errors.push(e)}C(e.step)&&(s=e.step,e.step=function(t){y=t,M()?b():(b(),0!==y.data.length&&(u+=t.data.length,e.preview&&u>e.preview?n.abort():(y.data=y.data[0],s(y,d))))}),this.parse=function(s,i,a){var l=e.quoteChar||'"';return e.newline||(e.newline=this.guessLineEndings(s,l)),r=!1,e.delimiter?C(e.delimiter)&&(e.delimiter=e.delimiter(s),y.meta.delimiter=e.delimiter):((l=((t,n,r,s,i)=>{var a,l,h,d;i=i||[",","\t","|",";",o.RECORD_SEP,o.UNIT_SEP];for(var u=0;u<i.length;u++){for(var c,p=i[u],g=0,m=0,v=0,y=(h=void 0,new f({comments:s,delimiter:p,newline:n,preview:10}).parse(t)),w=0;w<y.data.length;w++)r&&_(y.data[w])?v++:(m+=c=y.data[w].length,void 0===h?h=c:0<c&&(g+=Math.abs(c-h),h=c));0<y.data.length&&(m/=y.data.length-v),(void 0===l||g<=l)&&(void 0===d||d<m)&&1.99<m&&(l=g,a=p,d=m)}return{successful:!!(e.delimiter=a),bestDelimiter:a}})(s,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess)).successful?e.delimiter=l.bestDelimiter:(r=!0,e.delimiter=o.DefaultDelimiter),y.meta.delimiter=e.delimiter),l=w(e),e.preview&&e.header&&l.preview++,t=s,n=new f(l),y=n.parse(t,i,a),b(),p?{meta:{paused:!0}}:y||{meta:{paused:!1}}},this.paused=function(){return p},this.pause=function(){p=!0,n.abort(),t=C(e.chunk)?"":t.substring(n.getCharIndex())},this.resume=function(){d.streamer._halted?(p=!1,d.streamer.parseChunk(t,!0)):setTimeout(d.resume,3)},this.aborted=function(){return m},this.abort=function(){m=!0,n.abort(),y.meta.aborted=!0,C(e.complete)&&e.complete(y),t=""},this.guessLineEndings=function(e,t){e=e.substring(0,1048576),t=new RegExp(g(t)+"([^]*?)"+g(t),"gm");var n=(e=e.replace(t,"")).split("\r");if(e=1<(t=e.split("\n")).length&&t[0].length<n[0].length,1===n.length||e)return"\n";for(var r=0,s=0;s<n.length;s++)"\n"===n[s][0]&&r++;return r>=n.length/2?"\r\n":"\r"}}function g(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(e){var t=(e=e||{}).delimiter,n=e.newline,r=e.comments,s=e.step,i=e.preview,a=e.fastMode,l=null,h=!1,d=null==e.quoteChar?'"':e.quoteChar,u=d;if(void 0!==e.escapeChar&&(u=e.escapeChar),("string"!=typeof t||-1<o.BAD_DELIMITERS.indexOf(t))&&(t=","),r===t)throw new Error("Comment character same as delimiter");!0===r?r="#":("string"!=typeof r||-1<o.BAD_DELIMITERS.indexOf(r))&&(r=!1),"\n"!==n&&"\r"!==n&&"\r\n"!==n&&(n="\n");var c=0,p=!1;this.parse=function(o,f,m){if("string"!=typeof o)throw new Error("Input must be a string");var v=o.length,y=t.length,w=n.length,_=r.length,b=C(s),M=[],S=[],E=[],R=c=0;if(!o)return L();if(a||!1!==a&&-1===o.indexOf(d)){for(var T=o.split(n),x=0;x<T.length;x++){if(E=T[x],c+=E.length,x!==T.length-1)c+=n.length;else if(m)return L();if(!r||E.substring(0,_)!==r){if(b){if(M=[],D(E.split(t)),N(),p)return L()}else D(E.split(t));if(i&&i<=x)return M=M.slice(0,i),L(!0)}}return L()}for(var k=o.indexOf(t,c),O=o.indexOf(n,c),A=new RegExp(g(u)+g(d),"g"),F=o.indexOf(d,c);;)if(o[c]===d)for(F=c,c++;;){if(-1===(F=o.indexOf(d,F+1)))return m||S.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:M.length,index:c}),q();if(F===v-1)return q(o.substring(c,F).replace(A,d));if(d===u&&o[F+1]===u)F++;else if(d===u||0===F||o[F-1]!==u){-1!==k&&k<F+1&&(k=o.indexOf(t,F+1));var $=I(-1===(O=-1!==O&&O<F+1?o.indexOf(n,F+1):O)?k:Math.min(k,O));if(o.substr(F+1+$,y)===t){E.push(o.substring(c,F).replace(A,d)),o[c=F+1+$+y]!==d&&(F=o.indexOf(d,c)),k=o.indexOf(t,c),O=o.indexOf(n,c);break}if($=I(O),o.substring(F+1+$,F+1+$+w)===n){if(E.push(o.substring(c,F).replace(A,d)),j(F+1+$+w),k=o.indexOf(t,c),F=o.indexOf(d,c),b&&(N(),p))return L();if(i&&M.length>=i)return L(!0);break}S.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:M.length,index:c}),F++}}else if(r&&0===E.length&&o.substring(c,c+_)===r){if(-1===O)return L();c=O+w,O=o.indexOf(n,c),k=o.indexOf(t,c)}else if(-1!==k&&(k<O||-1===O))E.push(o.substring(c,k)),c=k+y,k=o.indexOf(t,c);else{if(-1===O)break;if(E.push(o.substring(c,O)),j(O+w),b&&(N(),p))return L();if(i&&M.length>=i)return L(!0)}return q();function D(e){M.push(e),R=c}function I(e){var t=0;return-1!==e&&(e=o.substring(F+1,e))&&""===e.trim()?e.length:t}function q(e){return m||(void 0===e&&(e=o.substring(c)),E.push(e),c=v,D(E),b&&N()),L()}function j(e){c=e,D(E),E=[],O=o.indexOf(n,c)}function L(r){if(e.header&&!f&&M.length&&!h){var s=M[0],i=Object.create(null),a=new Set(s);let t=!1;for(let n=0;n<s.length;n++){let r=s[n];if(i[r=C(e.transformHeader)?e.transformHeader(r,n):r]){let e,o=i[r];for(;e=r+"_"+o,o++,a.has(e););a.add(e),s[n]=e,i[r]++,t=!0,(l=null===l?{}:l)[e]=r}else i[r]=1,s[n]=r;a.add(r)}t&&console.warn("Duplicate headers found and renamed."),h=!0}return{data:M,errors:S,meta:{delimiter:t,linebreak:n,aborted:p,truncated:!!r,cursor:R+(f||0),renamedHeaders:l}}}function N(){s(L()),M=[],S=[]}},this.abort=function(){p=!0},this.getCharIndex=function(){return c}}function m(e){var t=e.data,n=i[t.workerId],r=!1;if(t.error)n.userError(t.error,t.file);else if(t.results&&t.results.data){var s={abort:function(){r=!0,v(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:y,resume:y};if(C(n.userStep)){for(var a=0;a<t.results.data.length&&(n.userStep({data:t.results.data[a],errors:t.results.errors,meta:t.results.meta},s),!r);a++);delete t.results}else C(n.userChunk)&&(n.userChunk(t.results,s,t.file),delete t.results)}t.finished&&!r&&v(t.workerId,t.results)}function v(e,t){var n=i[e];C(n.userComplete)&&n.userComplete(t),n.terminate(),delete i[e]}function y(){throw new Error("Not implemented.")}function w(e){if("object"!=typeof e||null===e)return e;var t,n=Array.isArray(e)?[]:{};for(t in e)n[t]=w(e[t]);return n}function _(e,t){return function(){e.apply(t,arguments)}}function C(e){return"function"==typeof e}return o.parse=function(t,r){var s=(r=r||{}).dynamicTyping||!1;if(C(s)&&(r.dynamicTypingFunction=s,s={}),r.dynamicTyping=s,r.transform=!!C(r.transform)&&r.transform,!r.worker||!o.WORKERS_SUPPORTED)return s=null,o.NODE_STREAM_INPUT,"string"==typeof t?(t=(e=>65279!==e.charCodeAt(0)?e:e.slice(1))(t),s=new(r.download?h:u)(r)):!0===t.readable&&C(t.read)&&C(t.on)?s=new c(r):(n.File&&t instanceof File||t instanceof Object)&&(s=new d(r)),s.stream(t);(s=(()=>{var t;return!!o.WORKERS_SUPPORTED&&(t=(()=>{var t=n.URL||n.webkitURL||null,r=e.toString();return o.BLOB_URL||(o.BLOB_URL=t.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",r,")();"],{type:"text/javascript"})))})(),(t=new n.Worker(t)).onmessage=m,t.id=a++,i[t.id]=t)})()).userStep=r.step,s.userChunk=r.chunk,s.userComplete=r.complete,s.userError=r.error,r.step=C(r.step),r.chunk=C(r.chunk),r.complete=C(r.complete),r.error=C(r.error),delete r.worker,s.postMessage({input:t,config:r,workerId:s.id})},o.unparse=function(e,t){var n=!1,r=!0,s=",",i="\r\n",a='"',l=a+a,h=!1,d=null,u=!1,c=((()=>{if("object"==typeof t){if("string"!=typeof t.delimiter||o.BAD_DELIMITERS.filter(function(e){return-1!==t.delimiter.indexOf(e)}).length||(s=t.delimiter),"boolean"!=typeof t.quotes&&"function"!=typeof t.quotes&&!Array.isArray(t.quotes)||(n=t.quotes),"boolean"!=typeof t.skipEmptyLines&&"string"!=typeof t.skipEmptyLines||(h=t.skipEmptyLines),"string"==typeof t.newline&&(i=t.newline),"string"==typeof t.quoteChar&&(a=t.quoteChar),"boolean"==typeof t.header&&(r=t.header),Array.isArray(t.columns)){if(0===t.columns.length)throw new Error("Option columns is empty");d=t.columns}void 0!==t.escapeChar&&(l=t.escapeChar+a),t.escapeFormulae instanceof RegExp?u=t.escapeFormulae:"boolean"==typeof t.escapeFormulae&&t.escapeFormulae&&(u=/^[=+\-@\t\r].*$/)}})(),new RegExp(g(a),"g"));if("string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return p(null,e,h);if("object"==typeof e[0])return p(d||Object.keys(e[0]),e,h)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||d),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:"object"==typeof e.data[0]?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||"object"==typeof e.data[0]||(e.data=[e.data])),p(e.fields||[],e.data||[],h);throw new Error("Unable to serialize unrecognized input");function p(e,t,n){var a="",o=("string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t)),Array.isArray(e)&&0<e.length),l=!Array.isArray(t[0]);if(o&&r){for(var h=0;h<e.length;h++)0<h&&(a+=s),a+=f(e[h],h);0<t.length&&(a+=i)}for(var d=0;d<t.length;d++){var u=(o?e:t[d]).length,c=!1,p=o?0===Object.keys(t[d]).length:0===t[d].length;if(n&&!o&&(c="greedy"===n?""===t[d].join("").trim():1===t[d].length&&0===t[d][0].length),"greedy"===n&&o){for(var g=[],m=0;m<u;m++){var v=l?e[m]:m;g.push(t[d][v])}c=""===g.join("").trim()}if(!c){for(var y=0;y<u;y++){0<y&&!p&&(a+=s);var w=o&&l?e[y]:y;a+=f(t[d][w],y)}d<t.length-1&&(!n||0<u&&!p)&&(a+=i)}}return a}function f(e,t){var r,i;return null==e?"":e.constructor===Date?JSON.stringify(e).slice(1,25):(i=!1,u&&"string"==typeof e&&u.test(e)&&(e="'"+e,i=!0),r=e.toString().replace(c,l),(i=i||!0===n||"function"==typeof n&&n(e,t)||Array.isArray(n)&&n[t]||((e,t)=>{for(var n=0;n<t.length;n++)if(-1<e.indexOf(t[n]))return!0;return!1})(r,o.BAD_DELIMITERS)||-1<r.indexOf(s)||" "===r.charAt(0)||" "===r.charAt(r.length-1))?a+r+a:r)}},o.RECORD_SEP=String.fromCharCode(30),o.UNIT_SEP=String.fromCharCode(31),o.BYTE_ORDER_MARK="\ufeff",o.BAD_DELIMITERS=["\r","\n",'"',o.BYTE_ORDER_MARK],o.WORKERS_SUPPORTED=!r&&!!n.Worker,o.NODE_STREAM_INPUT=1,o.LocalChunkSize=10485760,o.RemoteChunkSize=5242880,o.DefaultDelimiter=",",o.Parser=f,o.ParserHandle=p,o.NetworkStreamer=h,o.FileStreamer=d,o.StringStreamer=u,o.ReadableStreamStreamer=c,n.jQuery&&((t=n.jQuery).fn.parse=function(e){var r=e.config||{},s=[];return this.each(function(e){if("INPUT"!==t(this).prop("tagName").toUpperCase()||"file"!==t(this).attr("type").toLowerCase()||!n.FileReader||!this.files||0===this.files.length)return!0;for(var i=0;i<this.files.length;i++)s.push({file:this.files[i],inputElem:this,instanceConfig:t.extend({},r)})}),i(),this;function i(){if(0===s.length)C(e.complete)&&e.complete();else{var n,r,i,l,h=s[0];if(C(e.before)){var d=e.before(h.file,h.inputElem);if("object"==typeof d){if("abort"===d.action)return n="AbortError",r=h.file,i=h.inputElem,l=d.reason,void(C(e.error)&&e.error({name:n},r,i,l));if("skip"===d.action)return void a();"object"==typeof d.config&&(h.instanceConfig=t.extend(h.instanceConfig,d.config))}else if("skip"===d)return void a()}var u=h.instanceConfig.complete;h.instanceConfig.complete=function(e){C(u)&&u(e,h.file,h.inputElem),a()},o.parse(h.file,h.instanceConfig)}}function a(){s.splice(0,1),i()}}),s&&(n.onmessage=function(e){e=e.data,void 0===o.WORKER_ID&&e&&(o.WORKER_ID=e.workerId),"string"==typeof e.input?n.postMessage({workerId:o.WORKER_ID,results:o.parse(e.input,e.config),finished:!0}):(n.File&&e.input instanceof File||e.input instanceof Object)&&(e=o.parse(e.input,e.config))&&n.postMessage({workerId:o.WORKER_ID,results:e,finished:!0})}),(h.prototype=Object.create(l.prototype)).constructor=h,(d.prototype=Object.create(l.prototype)).constructor=d,(u.prototype=Object.create(u.prototype)).constructor=u,(c.prototype=Object.create(l.prototype)).constructor=c,o}()}(l);var h,d=o(l.exports);class u{get length(){return this.rows.length}constructor(e=[],t=null){this.index=0,this.rows=[],this.rows=e,this.headers=t}clone(){return new u(this.rows.map(e=>e.slice()),this.headers?this.headers.slice():null)}has(){return this.index<this.rows.length}row(e){if(e<0||e>=this.rows.length)throw new Error("Row index out of range");return new a(e,this.rows[e],this.headers)}current(){return this.row(this.index)}nextRow(){return this.row(this.index++)}[Symbol.iterator](){return this}next(){return this.has()?{done:!1,value:this.nextRow()}:{done:!0,value:void 0}}return(e){return this.rewind(),{done:!0,value:e}}throw(e){return this.rewind(),{done:!0,value:void 0}}rewind(){return this.index=0,this}map(e){const t=this.headers?this.headers.slice():null,n=this.rows.map((n,r)=>e(n,r,t));return new u(n,t)}forEach(e){const t=this.headers?this.headers.slice():null;return this.rows.forEach((n,r)=>e(n,r,t)),this}mapRows(e){const t=this.rows.map((t,n)=>e(new a(n,t,this.headers),this.headers).data);return new u(t,this.headers)}arrange(e){const t=[];for(const n of this)t.push(n.arrange(e));return new u(t,e)}toPlainObjects(){const e=[];for(const t of this)e.push(t.toPlainObject());return e}toRows(){const e=[];return this.headers&&e.push(this.headers),[...e,...this.rows]}toString(e={}){const t=this.toRows();return this.headers&&!(e.header??1)&&t.shift(),d.unparse(t,e)}addColumn(e,t=null,n=null){if(null===t&&(t="number"==typeof e?e:this.headers?.length??-1),"string"==typeof t)if(this.headers){let e=this.headers.lastIndexOf(t);if(-1===e)throw new Error(`Missing column "${t}"`);t=e+1}else t=-1;this.headers?.splice(t,0,String(e));for(const e of this.rows)e.splice(t,0,n);return this}renameColumn(e,t){return this.headers=this.headers?.map(n=>n===e?t:n)||null,this}remap(e){return e.forEach(({from:e,to:t})=>this.renameColumn(e,t)),this}remapColumns(e){return Array.isArray(e)?e.forEach(([e,t])=>{this.remapColumn(e,t)}):Object.entries(e).forEach(([e,t])=>this.remapColumn(e,t)),this}remapColumn(e,t){const n=Array.isArray(this.headers)&&this.headers.length>0,r=Array.isArray(this.rows)?this.rows.length:0,s=this.rows?.[0]?.length??(n?this.headers.length:0);if(0===s)return this;const i=Array.isArray(t)?[...t]:[t];if(0===i.length)return this;const a=(()=>{if("number"==typeof e){const t=e<0?s+e:e;if(!Number.isInteger(t)||t<0||t>=s)throw new Error(`remapColumn: index out of range: ${e}`);return[t]}if(!n)throw new Error(`remapColumn: cannot use header names without headers (got "${e}")`);const t=[];if(this.headers.forEach((n,r)=>{n===e&&t.push(r)}),0===t.length)throw new Error(`remapColumn: header not found: "${e}"`);return t})(),o=e=>Array.from({length:r},(t,n)=>this.rows?.[n]?.[e]);if(1===a.length){const e=a[0],t=o(e);n&&(this.headers[e]=i[0]);for(let e=1;e<i.length;e++){const s=i[e];n&&this.headers.push(s);for(let e=0;e<r;e++)this.rows[e].push(t[e])}return this}if(1===i.length){const e=i[0];if(n)for(const t of a)this.headers[t]=e;return this}if(i.length!==a.length)throw new Error(`remapColumn: mismatched arity (sources=${a.length}, targets=${i.length}). Use a single target name to rename all, or match lengths.`);return n&&a.forEach((e,t)=>this.headers[e]=i[t]),this}remapped(e){return this.clone().remap(e)}removeColumn(e){if("number"==typeof e)this.headers&&this.headers.splice(e,1),this.rows.forEach(t=>t.splice(e,1));else{if(!this.headers)throw new Error("Cannot remove header by name without headers present.");{let t;for(t=this.headers?.indexOf(e);void 0!==t&&t>-1;)this.removeColumn(t),t=this.headers?.indexOf(e)}}}reorderColumns(e){const t=Array.isArray(this.headers)&&this.headers.length>0,n=this.rows?.[0]?.length??(t?this.headers.length:0);if(!Array.isArray(e)||0===e.length)return this;if(0===n)return this;const r=new Map;t&&this.headers.forEach((e,t)=>{const n=r.get(e)??[];n.push(t),r.set(e,n)});const s=new Set,i=[],a=e=>{s.has(e)||(s.add(e),i.push(e))};for(const s of e)if("number"==typeof s){let e=s<0?n+s:s;if(!Number.isInteger(e)||e<0||e>=n)throw new Error(`reorderColumns: index out of range: ${s}`);a(e)}else{if(!t)throw new Error(`reorderColumns: cannot use header names without headers (got "${s}")`);const e=r.get(s);if(!e||0===e.length)throw new Error(`reorderColumns: unknown header "${s}"`);for(;e.length;)a(e.shift())}for(let e=0;e<n;e++)s.has(e)||i.push(e);return t&&(this.headers=i.map(e=>this.headers[e])),Array.isArray(this.rows)&&(this.rows=this.rows.map(e=>i.map(t=>e[t]))),this}}!function(e){e.ISO8601="iso8601",e.RFC822="rfc822",e.RFC850="rfc850",e.RFC1036="rfc1036",e.RFC1123="rfc1123",e.RFC7231="rfc7231",e.RFC2822="rfc2822",e.W3C="w3c"}(h||(h={}));class c{static validateFormat(e,t){return c.dateFormatToRegex(t).test(String(e))}static dateFormatToRegex(e,{anchors:t=!0,allowUppercaseMD:n=!0}={}){const r=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");switch(e.toLowerCase()){case h.ISO8601:return/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;case h.RFC822:return/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(?:0?[1-9]|[12]\d|3[01])\s(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(?:\d{2}|\d{4})\s(?:[01]\d|2[0-3]):[0-5]\d(?::[0-5]\d)?\s(?:[+-](?:[01]\d|2[0-3])[0-5]\d|UT|GMT|[ECMP][SD]T|[A-IK-Z])$/i;case h.RFC850:return/^(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday),\s(0[1-9]|[12]\d|3[01])-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{2}\s([01]\d|2[0-3]):[0-5]\d:[0-5]\d\sGMT$/i;case h.RFC1036:return/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s(?:0?[1-9]|[12]\d|3[01])\s(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{2}\s(?:[01]\d|2[0-3]):[0-5]\d:[0-5]\d\s(?:GMT|[PMCE][SD]T|[+-](?:[01]\d|2[0-3])[0-5]\d)$/i;case h.RFC1123:return/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s(0[1-9]|[12]\d|3[01])\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{4}\s([01]\d|2[0-3]):[0-5]\d:[0-5]\d\s(?:GMT|UT|[+-](?:[01]\d|2[0-3])[0-5]\d)$/i;case h.RFC7231:return/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s(0[1-9]|[12]\d|3[01])\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{4}\s([01]\d|2[0-3]):[0-5]\d:[0-5]\d\sGMT$/i;case h.RFC2822:return/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(0?[1-9]|[12]\d|3[01])\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{4}\s([01]\d|2[0-3]):[0-5]\d(?::[0-5]\d)?\s(?:[+-](?:[01]\d|2[0-3])[0-5]\d|UT|GMT|[ECMP][SD]T|[A-IK-Z])$/i;case h.W3C:return/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])T([01]\d|2[0-3]):[0-5]\d:[0-5]\d(?:\.\d+)?(?:Z|[+-](?:[01]\d|2[0-3]):[0-5]\d)$/}const s={X:"[-+]\\d{4}\\d*",Y:"-?\\d{4}\\d*",y:"-?\\d+",F:"(?:(?i)January|February|March|April|May|June|July|August|September|October|November|December)",M:"(?:(?i)Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)",m:"(?:0[1-9]|1[0-2])",n:"(?:[1-9]|1[0-2])",l:"(?:(?i)Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)",D:"(?:(?i)Mon|Tue|Wed|Thu|Fri|Sat|Sun)",d:"(?:0[1-9]|[12]\\d|3[01])",j:"(?:[1-9]|[12]\\d|3[01])",S:"(?:(?i)st|nd|rd|th)",a:"(am|pm)",A:"(AM|PM)",h:"(?:[0][0-9]|1[0-2])",H:"(?:[01]\\d|2[0-3])",g:"(?:\\d|1[0-2])",G:"(?:\\d|1\\d|2[0-3])",i:"[0-5]\\d",s:"[0-5]\\d",U:"\\d+"};n&&(s.M=s.m,s.D=s.d);let i="";for(let t=0;t<e.length;t++){const n=e[t];"\\"!==n?i+=s[n]||r(n):(t++,t<e.length&&(i+=r(e[t])))}return new RegExp((t?"^":"")+i+(t?"$":""))}static format(e,t){if(!e)return"";let n;if(e instanceof Date)n=e;else if(n=new Date(e),isNaN(n.getTime()))return"Invalid Date";switch(t.toLowerCase()){case h.RFC822:return n.toUTCString().replace("GMT","+0000");case h.RFC850:const e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][n.getUTCDay()]}, ${String(n.getUTCDate()).padStart(2,"0")}-${e[n.getUTCMonth()]}-${String(n.getUTCFullYear()).slice(-2)} ${String(n.getUTCHours()).padStart(2,"0")}:${String(n.getUTCMinutes()).padStart(2,"0")}:${String(n.getUTCSeconds()).padStart(2,"0")} GMT`;case h.RFC1036:case h.RFC1123:case h.RFC2822:case h.RFC7231:return n.toUTCString();case h.ISO8601:case h.W3C:return n.toISOString()}return c.formatWithPhpStyle(n,t)}static formatWithPhpStyle(e,t){const n={d:()=>String(e.getDate()).padStart(2,"0"),D:()=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][e.getDay()],j:()=>String(e.getDate()),l:()=>["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()],N:()=>String(e.getDay()||7),S:()=>{const t=e.getDate();if(t>=11&&t<=13)return"th";switch(t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}},w:()=>String(e.getDay()),z:()=>{const t=new Date(e.getFullYear(),0,1);return String(Math.floor((e.getTime()-t.getTime())/864e5))},W:()=>{const t=new Date(e.valueOf()),n=(e.getDay()+6)%7;t.setDate(t.getDate()-n+3);const r=t.valueOf();return t.setMonth(0,1),4!==t.getDay()&&t.setMonth(0,1+(4-t.getDay()+7)%7),String(1+Math.ceil((r-t.valueOf())/6048e5))},F:()=>["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()],m:()=>String(e.getMonth()+1).padStart(2,"0"),M:()=>["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],n:()=>String(e.getMonth()+1),t:()=>String(new Date(e.getFullYear(),e.getMonth()+1,0).getDate()),L:()=>{const t=e.getFullYear();return t%4==0&&t%100!=0||t%400==0?"1":"0"},o:()=>{const t=new Date(e.valueOf());return t.setDate(t.getDate()-(e.getDay()+6)%7+3),String(t.getFullYear())},X:()=>{const t=e.getFullYear();return(t>=0?"+":"")+String(t).padStart(4,"0")},Y:()=>String(e.getFullYear()),y:()=>String(e.getFullYear()).slice(-2),a:()=>e.getHours()<12?"am":"pm",A:()=>e.getHours()<12?"AM":"PM",B:()=>{const t=e.getUTCHours(),n=e.getUTCMinutes(),r=e.getUTCSeconds(),s=Math.floor((3600*t+60*n+r)/86.4);return String(s).padStart(3,"0")},g:()=>{const t=e.getHours()%12;return String(0===t?12:t)},G:()=>String(e.getHours()),h:()=>{const t=e.getHours()%12;return String(0===t?12:t).padStart(2,"0")},H:()=>String(e.getHours()).padStart(2,"0"),i:()=>String(e.getMinutes()).padStart(2,"0"),s:()=>String(e.getSeconds()).padStart(2,"0"),u:()=>String(1e3*e.getMilliseconds()).padStart(6,"0"),v:()=>String(e.getMilliseconds()).padStart(3,"0"),e:()=>Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",I:()=>{const t=new Date(e.getFullYear(),0,1),n=new Date(e.getFullYear(),6,1);return e.getTimezoneOffset()<Math.max(t.getTimezoneOffset(),n.getTimezoneOffset())?"1":"0"},O:()=>{const t=-e.getTimezoneOffset(),n=Math.floor(Math.abs(t)/60),r=Math.abs(t)%60;return(t>=0?"+":"-")+String(n).padStart(2,"0")+String(r).padStart(2,"0")},P:()=>{const t=-e.getTimezoneOffset(),n=Math.floor(Math.abs(t)/60),r=Math.abs(t)%60;return(t>=0?"+":"-")+String(n).padStart(2,"0")+":"+String(r).padStart(2,"0")},T:()=>{const t=Intl.DateTimeFormat().resolvedOptions().timeZone;if(t){const n=new Intl.DateTimeFormat("en",{timeZoneName:"short",timeZone:t}).formatToParts(e).find(e=>"timeZoneName"===e.type);return n?.value||"UTC"}return"UTC"},Z:()=>String(-60*e.getTimezoneOffset()),c:()=>e.toISOString(),r:()=>e.toUTCString(),U:()=>String(Math.floor(e.getTime()/1e3))};let r="",s=0;for(;s<t.length;){const e=t[s];"\\"===e?(s++,s<t.length&&(r+=t[s])):n[e]?r+=n[e]():r+=e,s++}return r}}const p=e=>String(e||"").toLowerCase().replace(/[_\-]/g," ").replace(/\s+/g," ").trim(),g=e=>e.replace(/[^a-zA-Z0-9-_]+/g,"-"),f=(...e)=>{},m=f,v=f,y=f,w=f,_=f,C=e=>{const t={};for(let[n,r]of Object.entries(e)){"string"==typeof r&&(r=[r]);for(const e of r)Array.isArray(t[e])?t[e].push(n):t[e]=[n]}return t};class b extends EventTarget{constructor(e={}){super(),this.options=Object.assign({allowUnmappedTargets:!1},e??{})}transform(e,t,n){const{isValid:r,missingRequired:s,mappedTargets:i}=this.validateRequiredMapping(t,n);if(!r)throw new Error(`Required columns are not mapped: ${s.join(", ")}`);if(0===Object.keys(t).length&&!n.some(e=>e.required))return this.handleEmptyMapping(e,t,n);const{data:a,errors:o}=this.transformRows(e,t,n);return{data:a,csv:this.generateCsv(a),validation:this.calculateValidationSummary(a,o)}}calculateValidationSummary(e,t){const n={},r={};return t.forEach(e=>{const t=e.field||"unknown";n[t]=(n[t]||0)+1,r[e.rowIndex]=(r[e.rowIndex]||0)+1}),{errors:t,totalRows:e.length,errorRows:Object.keys(r).length,totalErrors:t.length,errorsByField:n}}transformRows(e,t,n){let r=0;const s=[],i=C(t);let a=e.clone();a.remapColumns(t);const o=n.map(e=>e.outputHeader??e.name??e.title);if(a.headers&&!this.options.allowUnmappedTargets){const e=a.headers?.filter(e=>!i[e]);e.forEach(e=>a.removeColumn(e))}n.filter(e=>0===(i[e.name]||[]).length).map(e=>e.outputHeader??e.name).forEach(e=>{const t=n.find(t=>(t.outputHeader??t.name??t.title)===e);a.addColumn(e,null,t?.defaultValue??null)}),a.reorderColumns(o);const l=new Map;for(const e of a){for(const[t,i,a]of e.entries()){const o=l.get(a)??n.find(e=>(e.outputHeader??e.name??e.title)===a);if(l.set(a,o??null),!o)continue;let h=i;if(o.transform)try{h=this._transformValue(h,o.transform,r,a,o)}catch(e){const t=e instanceof Error?e.message:String(e);this._transformationError(r,a,h,t);continue}if(void 0!==o.validate){const t="string"==typeof o.validate?{type:o.validate}:o.validate;if(!b.validateValue(h,t)){let n;n="object"==typeof t&&null!==t&&"type"in t?`Value "${h}" is not a valid ${t.type}`:t instanceof RegExp?`Value "${h}" does not match pattern ${t}`:"function"==typeof t?`Value "${h}" failed custom validation`:`Value "${h}" is invalid`,o.validationMessage&&(n=o.validationMessage);this._valueValidationError(r,a,h,n)&&s.push({row:e,rowIndex:r,field:a,message:n,value:h})}}e.set(t,h)}r++}return{data:a,errors:s}}_guessBoolean(e){if("string"==typeof e){if(e=e.trim().toLowerCase(),["true","1","yes","y"].includes(e))return!0;if(["false","0","no","n"].includes(e))return!1}return Boolean(e)}static _transformNumber(e){if(null==e||""===e)return"";let t=String(e).trim();if(""===t)return"";if("NaN"===t||"Infinity"===t||"-Infinity"===t)return t;const n=t;let r=!1;t.startsWith("(")&&t.endsWith(")")&&(r=!0,t=t.slice(1,-1).trim());let s=!1;t.endsWith("%")&&(s=!0,t=t.slice(0,-1).trim()),t=t.replace(/^[$€£¥₹₽¢₩₪₨₦₡₵₴₸₺₼₾₿＄￠￡￥￦]/u,"");const i=t.lastIndexOf("."),a=t.lastIndexOf(",");if(-1!==i&&-1!==a)t=a>i?t.replace(/\./g,"").replace(",","."):t.replace(/,/g,"");else if(-1!==a&&-1===i){const e=t.substring(a+1);t=3===e.length&&/^\d+$/.test(e)&&a>0?t.replace(",",""):t.replace(",",".")}else t=-1===i&&-1===a?t.replace(/[\s'_]/g,""):t.replace(/,/g,"");t.match(/e[\s]*[+-]?\d+/i)||(t=t.replace(/[\s'_]/g,"")),t.startsWith("+")&&(t=t.slice(1)),r&&!t.startsWith("-")&&(t="-"+t);let o=parseFloat(t);return isNaN(o)&&(o=parseFloat(n),isNaN(o)&&(o=Number(n),isNaN(o)))?"":(s&&(o/=100),String(o))}_transformBoolean(e){if(this.options.booleanFormatter)if("function"==typeof this.options.booleanFormatter)e=this.options.booleanFormatter(e);else{if("object"!=typeof this.options.booleanFormatter)throw new Error("Invalid booleanFormatter option");e=(e=this._guessBoolean(e))?this.options.booleanFormatter.true:this.options.booleanFormatter.false}else e=this._guessBoolean(e)?"1":"0";return e}_transformDate(e,t,n,r){let s=this.options.dateFormatter;if("object"==typeof r.transform&&null!==r.transform&&"format"in r.transform&&void 0!==r.transform.format&&(s=r.transform.format),s)"function"==typeof s?e=s(e,t,n,r):"string"==typeof s&&(e=this._formatDateString(e,s));else{if(e=new Date(e),isNaN(e.getTime()))return"Invalid Date";e=`${new Date(e)}`}return e}_formatDateString(e,t){return c.format(e,t)}_transformValue(e,t,n,r,s){let a=t;if("object"!=typeof a||Array.isArray(a)||void 0===a.type||(a=a.type),"string"==typeof a&&(a=a.split("|").map(e=>e.trim())),Array.isArray(a))for(const t of a)if("string"==typeof t)switch(t){case"number":e=b._transformNumber(e);break;case"boolean":e=this._transformBoolean(e);break;case"date":e=this._transformDate(e,n,r,s);break;case"string":e=String(e);break;case"uppercase":e=String(e).toUpperCase();break;case"lowercase":e=String(e).toLowerCase();break;case"trim":e=String(e).trim();break;case"kebab":e=i.kebabCase(String(e));break;case"snake":e=i.snakeCase(String(e));break;case"screaming_snake":e=i.screamingSnakeCase(String(e));break;case"title":e=i.titleCase(String(e));break;case"pascal":e=i.pascalCase(String(e));break;case"camel":e=i.camelCase(String(e));break;case"ascii":e=i.ascii(String(e))}else"function"==typeof t&&(e=t(e,n,r,s));else"function"==typeof a&&(e=a(e,n,r,s));return e}generateCsv(e){return e.toString({quoteChar:this.options.quoteChar,escapeChar:this.options.escapeChar,delimiter:this.options.delimiter,newline:this.options.newline})}handleEmptyMapping(e,t,n){const r=[];for(let t=0;t<e.length;t++){const e=[];for(const t of n)e.push("");r.push(e)}const s=n.map(e=>e.outputHeader??e.name??e.title),i=new u(r,s),{data:a,errors:o}=this.transformRows(i,t,n);return{data:a,csv:this.generateCsv(i),validation:this.calculateValidationSummary(a,o)}}validateRequiredMapping(e,t){const n=[],r=this.getAllMappedTargets(e),s=new Set(r);for(const e of t)e.required&&void 0===e.defaultValue&&!s.has(e.name)&&n.push(e.name);return{isValid:0===n.length,missingRequired:n,mappedTargets:r}}getAllMappedTargets(e){const t=new Set;return Object.values(e).forEach(e=>{"string"==typeof e?t.add(e):e.forEach(e=>t.add(e))}),Array.from(t)}static validateValue(e,t){if(null==e||""===e)return!0;if(t instanceof RegExp)return b._validateRegex(e,t);if("function"==typeof t)try{return t(e)}catch(e){return!1}if("object"==typeof t&&null!==t){const n=t;switch(n.type){case"email":return b._validateRegex(e,/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/);case"number":const t=b._transformNumber(String(e));if(""===t&&""!==e)return!1;const r=Number(t);return!(isNaN(r)||!isFinite(r))&&(!(void 0!==n.min&&r<n.min)&&!(void 0!==n.max&&r>n.max));case"boolean":return["true","false","1","0","yes","no","y","n"].includes(String(e).toLowerCase());case"date":case"datetime":return n.format?c.validateFormat(String(e),n.format):!isNaN(Date.parse(e));case"phone":case"tel":case"telephone":return b._validateRegex(e,/^[\+]?[\d\s\-\(\)\.]{7,15}$/);case"time":return b._validateRegex(e,/^((([0-9]|1[0-2])(AM|PM))|(([01]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?( ?(AM|PM))?))$/);default:return!0}}return!0}static _validateRegex(e,t){return t.test(String(e))}updateOptions(e){Object.assign(this.options,e)}getOptions(){return{...this.options}}static toCsvRow(e,t=",",n='"',r=null){return e.map(e=>{const s=String(e??"");if(s.includes(t)||s.includes(n)||s.includes("\n")||s.includes("\r")){const e=r?s.replace(new RegExp(n,"g"),r+n):s.replace(new RegExp(n,"g"),n+n);return n+e+n}return s}).join(t)}_transformationError(e,t,n,r){return this.dispatchEvent(new CustomEvent("transformationError",{detail:{rowIndex:e,columnName:t,value:n,message:r}}))}_valueValidationError(e,t,n,r){const s=new CustomEvent("valueValidationError",{detail:{rowIndex:e,columnName:t,value:n,message:r}});return this.dispatchEvent(s)}}class M{static map(e,t,n="csvToConfig",r=.8,s={}){const i=n||"csvToConfig",a=new Map;if("csvToConfig"===i)for(const n of e){let e="",i=0;for(const r of t){const t=a.get(r.name)||0;if(!(!0===r.allowDuplicates||0===t))continue;const s=M.matchScore(n,r);s>i&&(i=s,e=r.name)}i>=r&&(M.addMapping(s,n,e),a.set(e,(a.get(e)||0)+1))}else for(const n of t){let t="",i=0;for(const r of e){if(!(0===(a.get(r)||0)))continue;const e=M.matchScore(r,n);e>i&&(i=e,t=r)}i>=r&&(M.addMapping(s,t,n.name),a.set(t,(a.get(t)||0)+1))}return s}static matchScore(e,t){const n=p(e),r=p(t.title||""),s=p(t.name||"");let i=0;if(t.match instanceof RegExp)(t.match.test(e)||t.match.test(n))&&(i=Math.max(i,1));else if("function"==typeof t.match)try{(t.match(e)||t.match(n))&&(i=Math.max(i,1))}catch(e){}return n!==s&&n!==r||(i=Math.max(i,.98)),(n.includes(s)||n.includes(r))&&(i=Math.max(i,.9)),i=Math.max(i,.85*M.similarity(n,s)),i=Math.max(i,.85*M.similarity(n,r)),i}static similarity(e,t){if(e=p(e),t=p(t),!e||!t)return 0;if(e===t)return 1;const n=e=>{const t=new Map;for(let n=0;n<e.length-1;n++){const r=e.slice(n,n+2);t.set(r,(t.get(r)||0)+1)}return t},r=n(e),s=n(t);let i=0,a=0;for(const[e,t]of r)s.has(e)&&(i+=Math.min(t,s.get(e))),a+=t;for(const[,e]of s)a+=e;return 2*i/(a||1)}static addMapping(e,t,n){const r=e[t];r?"string"==typeof r?r!==n&&(e[t]=[r,n]):r.includes(n)||r.push(n):e[t]=n}}class S{constructor(){this.container=null,this.mappingChangeCallback=null,this.currentOptions=null,this.hasInitialRender=!1,this.lastDrawnMap={},this.redrawHash={},S._ensureStyles(),this.uniqid=Math.random().toString(36).substring(2,10)}reset(){return this.lastDrawnMap={},this.redrawHash={},this}conditionallySetContents(e,t){e&&(e.innerHTML=t)}hashesAreEquivalent(e,t){return JSON.stringify(e)===JSON.stringify(t)}mappingModeHeaders(e){return["configToCsv"===e?"Your configured columns":"Your CSV headers","configToCsv"===e?"Map to CSV header":"Map to configured column"]}mappingModeText(e){return"configToCsv"===e?"(Config → CSV)":"(CSV → Config)"}tagText(e){return`${e.rowCount} rows • sep: ${this._escape(e.dialect.separator||",")}`}reRender(e,t){m("Re-Rendering"),this.container=e,this.currentOptions=t,e.dataset.mappingMode=t.mappingMode;const n={mappingMode:t.mappingMode,allowMultipleSelection:t.allowMultipleSelection,headers:t.headers.slice()};y(n,this.redrawHash,this.hashesAreEquivalent(this.redrawHash,n));const r=this._renderValidationMessages(t.validation),s=this.mappingModeText(t.mappingMode),[i,a]=this.mappingModeHeaders(t.mappingMode),o=this.tagText(t);e&&(this.conditionallySetContents(e.querySelector(`[id="${this.uniqid}-validation-display"]`),r),this.conditionallySetContents(e.querySelector(`[id="${this.uniqid}-mode"]`),s),this.conditionallySetContents(e.querySelector(`[id="${this.uniqid}-tag"]`),o),this.conditionallySetContents(e.querySelector(`[id="${this.uniqid}-header-left"]`),i),this.conditionallySetContents(e.querySelector(`[id="${this.uniqid}-header-right"]`),a),this.hashesAreEquivalent(this.redrawHash,n)&&this.hashesAreEquivalent(this.lastDrawnMap,t.fullMapping)?w({redrawHash:{before:this.redrawHash,after:n},lastDrawnMap:{before:this.lastDrawnMap,after:t.fullMapping}}):(this.conditionallySetContents(e.querySelector(`[id="${this.uniqid}-mapping-table-body"]`),this._renderMappingTable(t)),this._attachEventListeners())),this.redrawHash=n,this.lastDrawnMap=t.fullMapping,v("Re-Rendering")}render(e,t){if(this.hasInitialRender)return void this.reRender(e,t);if(m("Rendering"),this.container=e,this.currentOptions=t,e.dataset.mappingMode=t.mappingMode,!t.headers.length)return e.innerHTML=this._banner("No CSV loaded. Choose a file to begin."),void v("Rendering");const n=this._renderMappingTable(t),r=this._renderRequiredMappingStatus(t.mappingResult),s=this._renderValidationMessages(t.validation),i=this.mappingModeText(t.mappingMode),[a,o]=this.mappingModeHeaders(t.mappingMode),l=this.tagText(t);e.innerHTML=`\n      <div id="${this.uniqid}-mapping-display">${r}</div>\n      <div id="${this.uniqid}-validation-display">${s}</div>\n      <div class="csvm-card">\n        <div class="csvm-card-h">\n          Map your columns <span class="csvm-mapping-mode" id="${this.uniqid}-mode">${i}</span>\n          <span class="csvm-tag" id="${this.uniqid}-tag">${l}</span>\n        </div>\n        <div class="csvm-card-b">\n          <table class="csvm-table">\n            <thead>\n              <tr>\n                <th id="${this.uniqid}-header-left">${a}</th>\n                <th id="${this.uniqid}-header-right">${o}</th>\n              </tr>\n            </thead>\n            <tbody id="${this.uniqid}-mapping-table-body">\n              ${n}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    `,this._attachEventListeners(),this.hasInitialRender=!0,v("Rendering")}onMappingChange(e){this.mappingChangeCallback=e}updateMapping(e){if(!this.container||!this.currentOptions)return;const t=this.container.querySelector(".csvm-mapping-status");t&&(t.outerHTML=this._renderRequiredMappingStatus(e))}destroy(){this.container=null,this.mappingChangeCallback=null,this.currentOptions=null}showMessage(e){this.container&&(this.container.innerHTML=this._banner(e))}_renderRequiredMappingStatus(e){const{isValid:t,missingRequired:n}=e;return t?'<div class="csvm-mapping-status csvm-mapping-success">✓ All required columns are mapped</div>':`<div class="csvm-mapping-status csvm-mapping-error">\n          ⚠ Missing required columns: ${n.join(", ")}\n        </div>`}_renderValidationMessages(e){return e.errors.length<=0?"":`\n      <details class="csvm-validation-messages">\n        <summary>Validation Errors (${e.errors.length})</summary>\n        <ul>\n        ${e.errors.map(e=>`<li class="csvm-validation-error">${this._escape(e.message)}</li>`).join("")}\n        </ul>\n      </details>\n    `}_renderMappingTable(e){w("_renderMappingTable",{options:e});const t=C(e.fullMapping);return"configToCsv"===e.mappingMode?e.columnSpecs.map(n=>{let r=t[n.name]||"";const s=this._generateCsvHeaderOptions(e.headers,r,t,e.allowMultipleSelection);this.lastDrawnMap=e.fullMapping;const i=n.description?` title="${this._escape(n.description)}"`:"",a=n.comment?`\n<div class="csvm-comment">${this._escape(n.comment)}</div>`:"",o=n.allowDuplicates?" multiple":"";return`\n          <tr>\n            <td><strong${i}>${this._escape(n.title||n.name)}${n.required?" *":""}</strong>${a}</td>\n            <td>\n              <select id="${this.uniqid}-${g(n.name)}" name="${g(n.name)}" data-src="${this._escape(n.name)}"${i}${o}>\n                ${s}\n              </select>\n            </td>\n          </tr>\n        `}).join(""):e.headers.map(n=>{const r=e.fullMapping[n]||"",s=this._generateSelectOptions(e.columnSpecs,r,t,e.allowMultipleSelection),i=this._getFullMappingsForHeader(n,e),a=i.length>1,o=!e.allowMultipleSelection&&a?` <span class="csvm-multiple-mappings">(+${i.length-1} more: ${i.slice(1).join(", ")})</span>`:"",l=e.allowMultipleSelection?"multiple":"",h=e.allowMultipleSelection?"csvm-multi-select":"";return this.lastDrawnMap=e.fullMapping,`\n          <tr>\n            <td><strong>${this._escape(n)}</strong></td>\n            <td>\n              <select id="${this.uniqid}-${g(n)}" name="${g(n)}" data-src="${this._escape(n)}" ${l} class="${h}">\n                ${s}\n              </select>\n              ${o}\n            </td>\n          </tr>\n        `}).join("")}_generateSelectOptions(e,t,n,r){const s=new Map;Object.values(n).forEach(e=>{e&&(e=Array.isArray(e)?e:[e]).forEach(e=>s.set(e,(s.get(e)||0)+1))}),"string"==typeof t&&(t=[t]);return['<option value="">— Ignore —</option>',...e.map(e=>{const n=s.get(e.name)||0,i=t.includes(e.name),a=r||!0===e.allowDuplicates||0===n||i,o=a?"":"disabled",l=i?"selected":"",h=this._escape(e.title||e.name),d=e.required&&a?" *":"";return`<option class="${e.required?"required":""}" value="${this._escape(e.name)}" ${l} ${o}>${h}${d}</option>`})].join("")}_generateCsvHeaderOptions(e,t,n,r){Array.isArray(t)||(t=[t]),w({csvHeaders:e,currentTargetHeader:t,allMappings:n});const s=e.map(e=>{const s=t.includes(e);let i="";if(!r){const t=Object.entries(n).some(([t,n])=>n.includes(e));t&&!s&&(i="disabled")}const a=s?"selected":"",o=this._escape(e);return`<option value="${this._escape(e)}" ${a} ${i}>${o}</option>`});return['<option value="">— Ignore —</option>',...s].join("")}_attachEventListeners(){if(!this.container||!this.mappingChangeCallback)return;w("Attaching event listeners");this.container.querySelectorAll("select[data-src]").forEach(e=>{e.addEventListener("change",t=>{let n=e.getAttribute("data-src");const r=Array.from(e.selectedOptions).map(e=>e.value);w("Select changed",{sourceHeader:n,value:e.value,selectedOptions:r}),n&&(this.container?.dataset.mappingMode,this.mappingChangeCallback&&(this.lastDrawnMap=this.mappingChangeCallback(n,r)))})})}_banner(e){return`<div class="csvm-note">${this._escape(e)}</div>`}_escape(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}_getFullMappingsForHeader(e,t){if(!t.fullMapping||!t.fullMapping[e])return[];const n=t.fullMapping[e];return"string"==typeof n?[n]:[...n]}static _ensureStyles(){const e="csv-mapper-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n      /* Light theme (default) */\n      .csvm-card {\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        margin: 10px 0;\n        background: #ffffff;\n      }\n      .csvm-card-h {\n        background: #f8f9fa;\n        padding: 12px 16px;\n        border-bottom: 1px solid #ddd;\n        font-weight: 600;\n        color: #333;\n      }\n      .csvm-comment {\n        font-size: 0.8rem;\n      }\n      .csvm-card-b { padding: 0; }\n      .csvm-table {\n        width: 100%;\n        border-collapse: collapse;\n        background: #ffffff;\n      }\n      .csvm-table th, .csvm-table td {\n        padding: 8px 12px;\n        text-align: left;\n        border-bottom: 1px solid #eee;\n        color: #333;\n      }\n      .csvm-table th {\n        background: #f8f9fa;\n        font-weight: 600;\n      }\n      .csvm-table select {\n        width: 100%;\n        padding: 4px 8px;\n        border: 1px solid #ccc;\n        border-radius: 3px;\n        background: #ffffff;\n        color: #333;\n      }\n      .csvm-table select.csvm-multi-select {\n        min-height: 80px;\n      }\n      .csvm-tag {\n        background: #007cba;\n        color: white;\n        padding: 2px 6px;\n        border-radius: 3px;\n        font-size: 0.85em;\n        font-weight: normal;\n      }\n      .csvm-mapping-mode {\n        background: #28a745;\n        color: white;\n        padding: 2px 6px;\n        border-radius: 3px;\n        font-size: 0.85em;\n        font-weight: normal;\n        margin-right: 8px;\n      }\n      .csvm-note {\n        padding: 12px;\n        background: #f8f9fa;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        color: #6c757d;\n      }\n      .csvm-mapping-status, .csvm-validation-messages {\n        padding: 8px 12px;\n        margin-bottom: 10px;\n        border-radius: 4px;\n        font-weight: 500;\n      }\n      .csvm-mapping-success {\n        background: #d4edda;\n        border: 1px solid #c3e6cb;\n        color: #155724;\n      }\n      .csvm-mapping-error {\n        background: #f8d7da;\n        border: 1px solid #f5c6cb;\n        color: #721c24;\n      }\n      .csvm-validation-messages {\n        background: #f8d7da;\n        border: 1px solid #f5c6cb;\n        color: #721c24;\n      }\n      .csvm-validation-error {\n        padding: 4px 0;\n      }\n      .csvm-table select option.required:not(:disabled) {\n        font-weight: bold;\n        color: #721c24;\n      }\n      .csvm-multiple-mappings {\n        font-size: 0.85em;\n        color: #007cba;\n        font-weight: normal;\n        margin-left: 8px;\n      }\n\n      /* Dark theme */\n      @media (prefers-color-scheme: dark) {\n        .csvm-card {\n          border: 1px solid #444;\n          background: #1e1e1e;\n        }\n        .csvm-card-h {\n          background: #2d2d2d;\n          border-bottom: 1px solid #444;\n          color: #e0e0e0;\n        }\n        .csvm-table {\n          background: #1e1e1e;\n        }\n        .csvm-table th, .csvm-table td {\n          border-bottom: 1px solid #444;\n          color: #e0e0e0;\n        }\n        .csvm-table th {\n          background: #2d2d2d;\n        }\n        .csvm-table select {\n          border: 1px solid #555;\n          background: #2d2d2d;\n          color: #e0e0e0;\n        }\n        .csvm-table select.csvm-multi-select {\n          min-height: 80px;\n        }\n        .csvm-table select:focus {\n          border-color: #007cba;\n          outline: none;\n        }\n        .csvm-tag {\n          background: #0099e6;\n        }\n        .csvm-note {\n          background: #2d2d2d;\n          border: 1px solid #444;\n          color: #a0a0a0;\n        }\n        .csvm-mapping-success {\n          background: #1e3a1e;\n          border: 1px solid #2d5a2d;\n          color: #4caf50;\n        }\n        .csvm-mapping-error {\n          background: #3a1e1e;\n          border: 1px solid #5a2d2d;\n          color: #f44336;\n        }\n        .csvm-validation-messages {\n          background: #3a1e1e;\n          border: 1px solid #5a2d2d;\n          color: #f44336;\n        }\n        .csvm-table select option.required:not(:disabled) {\n          color: #f44336;\n        }\n        .csvm-multiple-mappings {\n          color: #0099e6;\n        }\n      }\n    ",document.head.appendChild(t)}}class E{parseCSV(e,{headers:t=!0,delimiter:n="",quoteChar:r="",escapeChar:s=""}={}){const i={header:!1,skipEmptyLines:!0,dynamicTyping:!1};n&&(i.delimiter=n),r&&(i.quoteChar=r),s&&(i.escapeChar=s);const a=d.parse(e,i);a.errors.length>0&&console.warn("PapaParse errors:",a.errors);const o=a.data;for(;o.length>0&&o[o.length-1].every(e=>""===e);)o.pop();if(0===o.length)return{headers:[],rows:[],rawRows:[],dialect:{separator:n||",",enclosure:r||'"',escape:s||null}};const l={separator:a.meta.delimiter||n||",",enclosure:r||'"',escape:s||null};if(t){const e=o.shift()||[],t=o.map(t=>Object.fromEntries(e.map((e,n)=>[e,t[n]??""])));return{headers:e,rows:t,rawRows:o,dialect:l}}const h=o.reduce((e,t)=>Math.max(e,t.length),0),u=Array.from({length:h},(e,t)=>`Column ${t+1}`),c=o.map(e=>Object.fromEntries(u.map((t,n)=>[t,e[n]??""])));return{headers:u,rows:c,rawRows:o,dialect:l}}detectDialect(e,{delimiter:t=null,quoteChar:n=null,escapeChar:r=null}={}){let s=e;const i={header:!1,preview:5,skipEmptyLines:!0};t&&(i.delimiter=t),n&&(i.quoteChar=n),r&&(i.escapeChar=r);return{separator:d.parse(s,i).meta.delimiter||t||",",enclosure:n||'"',escape:r||null}}toCsvRow(e,t=",",n='"',r=null){const s={delimiter:t,quoteChar:n,header:!1};return r&&(s.escapeChar=r),d.unparse([e.map(e=>String(e??""))],s)}_parseWithDialect(e,t,n,r){const s={header:!1,delimiter:t,quoteChar:n,skipEmptyLines:!0,dynamicTyping:!1};r&&(s.escapeChar=r);return d.parse(e,s).data}_getSampleText(e,t){if(t<=0)return e;return e.split(/\r\n|\n|\r/).slice(0,t).join("\n")}_mode(e){const t=new Map;let n=null,r=-1;for(const s of e){const e=(t.get(s)||0)+1;t.set(s,e),e>r&&(n=s,r=e)}return n}_escRe(e){return e.replace(/[.*+?^${}()|[\]\\]/g,e=>`\\${e}`)}}class R extends EventTarget{get headers(){return this.csv?.headers??[]}constructor(e,t={}){if(super(),this.input=null,this.columns=[],this.controlsEl=null,this.mapping={},this.dialect={separator:",",enclosure:'"',escape:null},this.isValid=!0,this.csv=null,"string"==typeof e){const t=document.querySelector(e);if(!(t instanceof HTMLInputElement))throw new Error("CsvMapper: first argument must be a file input, selector or options object.");e=t}if(e instanceof HTMLInputElement){if(this.input=e,"file"!==this.input.type)throw new Error("CsvMapper: first argument must be a file input, selector or options object.")}else{if("object"!=typeof e||e instanceof HTMLElement)throw new Error("CsvMapper: first argument must be a file input, selector or options object.");t=e}this.opts=Object.assign({headers:!0,delimiter:"",quoteChar:"",escapeChar:"",remap:!0,showUserControls:!!this.input,mappingInput:null,controlsContainer:null,columns:[],autoThreshold:.8,setInputValidity:!1,uiRenderer:null,mappingMode:"configToCsv",allowMultipleSelection:!1},t||{}),this.setColumns(t.columns),this.parser=this.opts.parser||new E,this.setUiRenderer(this.opts.uiRenderer),this.setTransformer(this.opts.transformer??new b(this.opts.output??{})),this.controlsEl=this._resolveNode(this.opts.controlsContainer||null)||this._autoinsertContainer(),this._onFileChange=this._onFileChange.bind(this),this.input&&this.input.addEventListener("change",this._onFileChange)}destroy(){this.input&&this.input.removeEventListener("change",this._onFileChange),this.controlsEl&&"1"===this.controlsEl.dataset.csvMapperAutocreated&&this.controlsEl.remove(),this.uiRenderer.destroy()}getHeaders(){return[...this.headers]}getDialect(){return Object.assign({},this.dialect)}setColumns(e=[]){this.columns=e.map(e=>"string"==typeof e?{name:e}:Object.assign({},e)),this.columns.forEach(e=>{e.title||(e.title=e.name)})}getMapping(){return Object.assign({},this.mapping)}setMapping(e){this.mapping={},e&&Object.entries(e).forEach(([e,t])=>{"string"==typeof t?t&&this._addMapping(e,t):t.forEach(t=>{t&&this._addMapping(e,t)})}),this._onMappingChange()}resetColumnMapping(){this.mapping={},this._onMappingChange()}addColumnMappings(e){e.forEach(({csvHeader:e,configColumn:t})=>{this._addMapping(e,t)}),this._onMappingChange()}addColumnMapping(e,t){this._addMapping(e,t),this._onMappingChange()}removeColumnMapping(e,t){this._removeMapping(e,t),this._onMappingChange()}clearColumnMapping(e){this._clearMapping(e),this._onMappingChange()}getColumnMappings(e){return this._getMappedColumns(e)}getAllMappings(){const e={};return this.headers.forEach(t=>{e[t]=this._getMappedColumns(t)}),e}getParser(){return this.parser}setParser(e){this.parser=e}getUiRenderer(){return this.uiRenderer}setUiRenderer(e){this.uiRenderer=this._resolveUiRenderer(e)}getTransformer(){return this.transformer}setTransformer(e){this.transformer=e,this.transformer.addEventListener("transformationFail",e=>{const t=new CustomEvent("transformationFail",e);return this.dispatchEvent(t)}),this.transformer.addEventListener("validationFail",e=>{const t=new CustomEvent("validationFail",e);return this.dispatchEvent(t)})}async setFile(e){this.isValid=!0,this.csv=null,this.uiRenderer.reset();const t={detail:{text:await e.text()}},n=new CustomEvent("afterRead",t);this.dispatchEvent(n),this.mapping={},this.mapCsv(t.detail.text)}setCsv(e){this._beforeParseCsv(e);const t=this.parser.parseCSV(e,{headers:this.opts.headers,delimiter:this.opts.delimiter,quoteChar:this.opts.quoteChar,escapeChar:this.opts.escapeChar});return this._afterParseCsv(t),this.csv=new u(t.rawRows,t.headers),this.dialect=t.dialect,this}autoMap(){M.map(this.headers,this.columns,this.opts.mappingMode,this.opts.autoThreshold||.8,this.mapping)}render(){this._renderControls()}mapCsv(e){return void 0!==e&&this.setCsv(e),this.csv?(this._autoMap(),this.opts.showUserControls&&this._renderControls(),this.getMappedResult()??!1):(w("No csv"),!1)}remap(){this.isValid=!0,this._renderControls();const e=new CustomEvent("beforeMap",{detail:{csv:this.csv}});this.dispatchEvent(e);const t=this._validateMapping(),n=new CustomEvent("afterMap",{detail:{csv:this.csv,isValid:t.isValid}});return this.dispatchEvent(n),t.isValid}getMappedResult(){if(this.remap()){const e=new CustomEvent("beforeRemap",{detail:{csv:this.csv}});this.dispatchEvent(e);const{data:t,csv:n,validation:r}=this._produceOutput(),s=new CustomEvent("afterRemap",{detail:{rows:t.rows,csv:n}});this.dispatchEvent(s);const i=this._resolveNode(this.opts.mappingInput||null);return i instanceof HTMLInputElement&&(i.value=JSON.stringify(this.mapping)),this._renderControls(r),this.input&&this.opts.remap&&n&&this._replaceInputFileWithCsv(n),{data:t,csv:n,validation:r}}}_replaceInputFileWithCsv(e){const t=this.input.files?.[0],n=new Blob([e],{type:"text/csv"}),r=new File([n],t?.name??"remapped.csv",{type:"text/csv"});this._tryReplaceFileList(r)||console.warn("Could not replace file input contents - browser may not support it.")}_tryReplaceFileList(e){try{const t=new DataTransfer;return t.items.add(e),this.input.files=t.files,this.input.files?.[0]?.name===e.name}catch{return!1}}_resolveUiRenderer(e){return(e="string"==typeof e?new S:e||new S).onMappingChange((e,t)=>{if("configToCsv"===this.opts.mappingMode){const n=Array.isArray(t)?t:[t],r=e;for(let[e,t]of Object.entries(this.mapping))t=Array.isArray(t)?t:[t],t.includes(r)&&this._removeMapping(e,r);for(const e of n)this._addMapping(e,r)}else Array.isArray(t)&&(1===t.length?t=t[0]:0===t.length&&(t="")),this.mapping[e]=t;return _(this.mapping),this._onMappingChange(),this.getMappedResult(),this.mapping}),e}async _onFileChange(){if(this.isValid=!0,this.csv=null,this.uiRenderer.reset(),this.input){const e=this.input.files&&this.input.files[0];if(!e)return;this.setFile(e)}}_beforeParseCsv(e){this.dispatchEvent(new CustomEvent("beforeParseCsv",{detail:{csv:e}}))}_afterParseCsv(e){this.dispatchEvent(new CustomEvent("afterParseCsv",{detail:{csv:e}}))}_autoMap(){this.autoMap(),this._mappingChangeEvent()}_validateMapping(){const{isValid:e,mappedTargets:t,missingRequired:n}=this.validateRequiredColumns();if(this.isValid=e,!1===e){const e=new CustomEvent("mappingFailed",{detail:{isValid:this.isValid,mappedTargets:t,mapping:this.mapping,missingRequired:n}});this.dispatchEvent(e)}else{const e=new CustomEvent("mappingSuccess",{detail:{isValid:this.isValid,mappedTargets:t,mapping:this.mapping}});this.dispatchEvent(e)}if(this.opts.setInputValidity&&this.input){if(e)this.input.setCustomValidity("");else{const e=`Missing required columns: ${n.join(", ")}`;this.input.setCustomValidity(e)}this.input.reportValidity()}return{isValid:e,mappedTargets:t,missingRequired:n}}_onMappingChange(){this.isValid=!0,this._mappingChangeEvent(),this.remap()}_mappingChangeEvent(){const e=new CustomEvent("mappingChange",{detail:{mapping:this.mapping}});this.dispatchEvent(e)}validateRequiredColumns(){const e=[],t=this._getAllMappedTargets(),n=new Set(t);for(const t of this.columns)t.required&&void 0===t.defaultValue&&!n.has(t.name)&&e.push(t.name);return{isValid:0===e.length,missingRequired:e,mappedTargets:t}}_addMapping(e,t){const n=this.mapping[e];n?"string"==typeof n?n!==t&&(this.mapping[e]=[n,t]):n.includes(t)||n.push(t):this.mapping[e]=t}_removeMapping(e,t){const n=this.mapping[e];if(n)if("string"==typeof n)n===t&&delete this.mapping[e];else{const r=n.indexOf(t);r>-1&&(n.splice(r,1),0===n.length?delete this.mapping[e]:1===n.length&&(this.mapping[e]=n[0]))}}_clearMapping(e){delete this.mapping[e]}_getMappedColumns(e){const t=this.mapping[e];return t?"string"==typeof t?[t]:[...t]:[]}_getAllMappedTargets(){const e=new Set;return Object.values(this.mapping).forEach(t=>{"string"==typeof t?e.add(t):t.forEach(t=>e.add(t))}),Array.from(e)}_getSimpleMapping(){const e={};return Object.entries(this.mapping).forEach(([t,n])=>{"string"==typeof n?e[t]=n:n.length>0&&(e[t]=n[0])}),e}_getReverseMapping(){const e={};return Object.entries(this.mapping).forEach(([t,n])=>{"string"==typeof n?e[n]=t:n.length>0&&n.forEach(n=>{e[n]=t})}),e}_produceOutput(){const e=this.validateRequiredColumns();if(!e.isValid)throw new Error(`Required columns are not mapped: ${e.missingRequired.join(", ")}`);const t=this.csv??new u,n=this.transformer.transform(t,this.mapping,this.columns),r=n.data,s=n.validation,i=n.csv;if(s.totalErrors>0){const e=new CustomEvent("validationFailed",{detail:{...n}});if(this.dispatchEvent(e),this.isValid=!1,this.input){const e=s.errors,t=e.length>1;let n=`There ${t?"were":"was"} ${e.length} total validation/transformation error${t?"s":""} across ${s.errorRows} ${s.errorRows>1?"rows":"row"}:\n`+e.slice(0,5).map(e=>`Row ${e.rowIndex} [${e.field}] {${((e,t,n="...")=>e.length<=t?e:e.slice(0,t-n.length)+n)(String(e.value),20)}}`).join("\n");e.length>5&&(n+="\n...and "+(e.length-5)+" more errors"),this.opts.setInputValidity&&(this.input.setCustomValidity(n),this.input.reportValidity())}}else{const e=new CustomEvent("validationSuccess",{detail:{...n}});this.dispatchEvent(e),this.opts.setInputValidity&&this.input&&(this.input.setCustomValidity(""),this.input.reportValidity())}return{data:r,csv:i,validation:s}}_renderControls(e={errors:[],totalRows:0,errorRows:0,totalErrors:0,errorsByField:{}}){if(!this.controlsEl||!this.opts.showUserControls)return;if(!this.headers.length)return void this.uiRenderer.showMessage?.("No CSV loaded. Choose a file to begin.");const t=this._getMappingStatus(),n=this.opts.mappingMode||"csvToConfig",r="configToCsv"===n?this._getReverseMapping():this._getSimpleMapping(),s={headers:this.headers,columnSpecs:this.columns,currentMapping:r,fullMapping:this.mapping,mappingResult:t,validation:e,rowCount:this.csv?.length||0,dialect:this.dialect,mappingMode:n,allowMultipleSelection:this.opts.allowMultipleSelection};this.uiRenderer.render(this.controlsEl,s)}redraw(){this._renderControls()}_getMappingStatus(){const e=this.columns.filter(e=>!0===e.required),t=this._getAllMappedTargets(),n=new Set(t),r=e.filter(e=>!n.has(e.name));return{isValid:0===r.length,missingRequired:r.map(e=>e.title||e.name),mappedColumns:t}}_resolveNode(e){return e?"string"==typeof e?document.querySelector(e):e:null}_autoinsertContainer(){if(!this.opts.showUserControls||!this.input)return null;const e=document.createElement("div");return e.dataset.csvMapperAutocreated="1",this.input.insertAdjacentElement("afterend",e),e}static parseCSV(e,t={}){return(new E).parseCSV(e,t)}static detectDialect(e,t={}){return(new E).detectDialect(e,t)}}return R.DefaultUIRenderer=S,R});
//# sourceMappingURL=csv-mapper.umd.min.js.map
